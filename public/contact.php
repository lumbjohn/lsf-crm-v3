<?php include 'inc/config.php'; ?>
<?php
if (!isset($_GET['id_contact']))
	header('Location: contacts.php');
if ($_GET['id_contact'] == '0')
	$curusr = false;
else {

	$curusr = Contact::findOne(array('c.id_contact' => (int)$_GET['id_contact']));
	if ($curusr) {
		//$outuserlot = GridManager::getGrid('gwi_user_lottery', $_GET['id_user']); 

		if (CrmUser::isManager($currentUser) && ($curusr->id_team != $currentUser->id_team && !in_array($curusr->id_team, explode(',', $currentUser->teams))))
			header('Location: contacts.php');
	} else
		header('Location: contacts.php');
}

$sets = (object)Setting::getGlobalSettings();
$comments = Comment::getBy(array('id_contact' => (int)$_GET['id_contact']));
$docs = Doc::getBy(array('id_contact' => (int)$_GET['id_contact']));
$prest = Prestation::findOne(array('id_contact' => (int)$_GET['id_contact']));
$isdoublonfiscal = 0;
if ($prest) {
	$doubfisc = Prestation::findDoublonFiscal($prest);
	$isdoublonfiscal = $doubfisc ? $doubfisc->id_contact : 0;
}
$rdvs = RDV::getBy(array('r.id_contact' => (int)$_GET['id_contact'], 'type_rdv' => '0'));
$outlogs = GridManager::getGrid('iso_crmaction_ct', $_GET['id_contact']);
$outaudits = GridManager::getGrid('iso_audits', $_GET['id_contact']);
$zonetodis = (int)$curusr->cancel_update_team == 1 && (CrmUser::isTelepro($currentUser) || CrmUser::isManager($currentUser));



//TEST
// $cookie_jar = 'cookietest.txt'; 
// // log in 
// $c = curl_init('https://admin.dossier-c2e.fr/login'); 
// curl_setopt($c, CURLOPT_RETURNTRANSFER, 1); 
// curl_setopt($c, CURLOPT_COOKIEJAR, $cookie_jar);  
// curl_setopt($ch, CURLOPT_COOKIEFILE, $cookie_jar);
// $page = curl_exec($c); 
// curl_close($c); 

// $a = explode(' name="_csrf_token" value="', $page);
// $a = explode('"', $a[1])[0];

// // Generated by curl-to-PHP: http://incarnate.github.io/curl-to-php/
// $ch = curl_init();

// curl_setopt($ch, CURLOPT_URL, 'https://admin.dossier-c2e.fr/login_check');
// curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
// CURL_SETOPT($ch, CURLOPT_FOLLOWLOCATION, true);
// $pst = array(
// 	'_csrf_token' => urlencode($a),
// 	'_username' => 'lumb.john+com@gmail.com',
// 	'_password' => 'YCHGXSPA'
// );
// curl_setopt($ch, CURLOPT_POST, true);
// curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($pst)); 
// CURL_SETOPT($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:68.0) Gecko/20100101 Firefox/68.0');
// //curl_setopt($ch, CURLOPT_POST, 1);
// curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
// //curl_setopt($ch, CURLOPT_ENCODING, 'gzip, deflate');

// $headers = array();
// $headers[] = 'Origin: https://admin.dossier-c2e.fr/login';
// $headers[] = 'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:68.0) Gecko/20100101 Firefox/68.0';
// $headers[] = 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8';
// $headers[] = 'Accept-Language: fr,fr-FR;q=0.8,en-US;q=0.5,en;q=0.3';
// $headers[] = 'Referer: https://admin.dossier-c2e.fr/login';
// $headers[] = 'Content-Type: application/x-www-form-urlencoded';
// $headers[] = 'Connection: keep-alive';
// //$headers[] = 'Cookie: device_view_custom=full; PHPSESSID=4p49157cviivf7etd8epm1dqdi';
// $headers[] = 'Upgrade-Insecure-Requests: 1';
// //curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
// curl_setopt($ch, CURLOPT_COOKIEFILE, $cookie_jar);
// //curl_setopt($c, CURLOPT_COOKIEJAR, $cookie_jar);  
// //curl_setopt($ch, CURLOPT_NOBODY  , true);
// curl_setopt($ch, CURLOPT_HEADER, 1);

// $result = curl_exec($ch);
// //$redirectURL = curl_getinfo($ch,CURLINFO_EFFECTIVE_URL );

// curl_setopt($ch, CURLOPT_URL, 'https://admin.dossier-c2e.fr/program/factory/JJPWV');
// $result = curl_exec($ch);

// $a = explode(' name="meta_moteur[_token]" value="', $result);
// $a = explode('"', $a[1])[0];


// $pst = array(
// 	'meta_moteur[energie_de_chauffage]' => 'electricite',
// 	'meta_moteur[construction_plus_2_ans]' => 'non',
// 	'meta_moteur[codepostal]' => '25000',
// 	'meta_moteur[bar-en-101-t][surface_estime_comble]' => '50',
// 	'meta_moteur[bar-en-101-t][surface_sol]' => '60',
// 	'meta_moteur[bar-en-101-t][sous_toiture]' => 'vide',
// 	'meta_moteur[bar-en-101-t][escalier_comble]' => 'oui',
// 	'meta_moteur[bar-en-101-t][comble]' => 'surface_plate',
// 	'meta_moteur[bar-en-101-t][nb_etages]' => '2_etages',
// 	'meta_moteur[bar-en-101-t][revetement_toiture]' => 'tuiles',
// 	'meta_moteur[bar-en-102][surface_isolant]' => '0',
// 	'meta_moteur[bar-en-103][surface_isolant]' => '0',
// 	'meta_moteur[bar-en-103][isolation_zone]' => 'oui',
// 	'meta_moteur[_token]' => urlencode($a),
// 	'submitBtn' => ''
// );
// curl_setopt($ch, CURLOPT_POST, true);
// curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($pst)); 
// $result = curl_exec($ch);

//  if (curl_errno($ch)) {
//      echo 'Error:' . curl_error($ch);
//  }
//  curl_close($ch);
//  die($result);


?>
<?php include 'inc/template_start.php'; ?>
<?php include 'inc/page_head.php'; ?>

<!-- Page content -->
<div id="page-content" class="page-contact">
	<!-- eCommerce Dashboard Header -->
	<div class="content-header">
		<?php include('inc/menutop.php'); ?>
	</div>
	<!-- END eCommerce Dashboard Header -->

	<!-- eShop Overview Block -->
	<div class="block full row">
		<!-- eShop Overview Title -->
		<div class="row">
			<div class="col-lg-4">
				<div class="block">
					<!-- Normal Form Title -->
					<div class="block-title">
						<h2><strong>Informations</strong> client / prospect</h2>
						<?php if ($curusr) { ?>
							<div class="block-options pull-right">
								<span class="label label-primary">ID: <?php echo $curusr->id_contact; ?></span>
							</div>
						<?php } ?>
					</div>
					<!-- END Normal Form Title -->

					<form onsubmit="return false;" class="form-bordered form-horizontal" method="post" action="crmajax.php" id="frminfousr">
						<fieldset <?php echo $zonetodis ? 'disabled="disabled"' : ''; ?>>	
							<!-- Normal Form Content -->
							<div class="form-group">
								<label for="id_statuscont" class="col-md-3 control-label">Statut <span class="text-danger">*</span></label>
								<div class="col-md-9">
									<select data-placeholder="Choisissez le statut..." class="select-chosen" id="id_statuscont" name="id_statuscont" class="form-control">
										<option value=""></option>
										<?php
										$sts = Setting::getAllStatus();
										if ($sts) {
											foreach ($sts as $st) {
												$issel = $curusr ? ($st['id_statuscont'] == $curusr->id_statuscont ? 'selected="selected"' : '') : ($st['name_statuscont'] == 'Nouveau' ? 'selected="selected"' : '');
												echo '<option value="' . $st['id_statuscont'] . '" ' .$issel. '>' . $st['name_statuscont'] . '</option>';
											}
										}
										?>
									</select>
								</div>
							</div>
							<div class="form-group" style="border-bottom: solid 3px #ccc;margin-bottom: 10px;">
								<label for="id_statuscont" class="col-md-3 control-label">Statut confirmateur</label>
								<div class="col-md-9">
									<select data-placeholder="Choisissez le statut..." class="select-chosen" id="id_statuscontconf" name="id_statuscontconf" class="form-control" <?php echo CrmUser::isTelepro($currentUser) || CrmUser::isManager($currentUser) ? 'readonly="readonly"' : ''; ?>>
										<option value=""></option>
										<?php
										$sts = Setting::getAllStatusConf();
										if ($sts) {
											foreach ($sts as $st) {
												$issel = $curusr ? ($st['id_statuscontconf'] == $curusr->id_statuscontconf ? 'selected="selected"' : '') : (strstr($st['name_statuscontconf'], 'Nouveau') ? 'selected="selected"' : '');
												echo '<option value="' . $st['id_statuscontconf'] . '" ' . $issel . '>' . $st['name_statuscontconf'] . '</option>';
											}
										}
										?>
									</select>
								</div>
							</div>
							<div class="form-group">
								<label for="first_name" class="col-md-3 control-label">Prénom <span class="text-danger">*</span></label>
								<div class="col-md-9">
									<input type="text" placeholder="Saisissez le prénom..." class="form-control" name="first_name" id="first_name" value="<?php echo $curusr->first_name; ?>" required>
								</div>
							</div>
							<div class="form-group">
								<label for="last_name" class="col-md-3 control-label">Nom <span class="text-danger">*</span></label>
								<div class="col-md-9">
									<input type="text" placeholder="Saisissez le nom..." class="form-control" name="last_name" id="last_name" value="<?php echo $curusr->last_name; ?>" required>
								</div>
							</div>
							<?php /*
							<div class="form-group">
								<label for="date_rdv_pros" class="col-md-3 control-label">Date de rendez vous provisoire</label>
								<div class="col-md-9">
									<input type="text" placeholder="Date de rendez vous" class="form-control input-datepicker" data-date-format="dd/mm/yyyy" placeholder="dd/mm/yyyy" name="date_rdv_pros" id="date_rdv_pros" value="<?php echo $curusr->date_rdv_pros > 0 ? date('d/m/Y', strtotime($curusr->date_rdv_pros)) : ''; ?>">
								</div>
							</div>
							<div class="form-group">
								<label for="heure_rdv_pros" class="col-md-3 control-label">Heure de rendez vous provisoire</label>
								<div class="col-md-9">
									<div class="input-group bootstrap-timepicker">
										<input type="text"  name="heure_rdv_pros" id="heure_rdv_pros" value="<?php echo $curusr->heure_rdv_pros; ?>" class="form-control input-timepicker24">
										<span class="input-group-btn">
											<a href="javascript:void(0)" class="btn btn-primary"><i class="fa fa-clock-o"></i></a>
										</span>
									</div>
								</div>
							</div>
							*/ ?>
							<?php /* if ($curusr) { ?>
								<div class="form-group">
									<label for="creneau_start" class="col-md-3 control-label">Créneau du Rendez vous</label>
									<div class="col-md-3">
										<select name="creneau_start" id="creneau_start" class="form-control">
											<?php
											for ($hr = 7; $hr < 21; $hr++)
												echo '<option value="' . $hr . '" '.(date('H', strtotime($curusr->creneau_start)) == $hr ? 'selected="selected"' : '').'>' . $hr . 'h</option>';
											?>
										</select>
									</div>
									<div class="col-md-3">
										<select name="creneau_end" id="creneau_end" class="form-control">
											<?php
											for ($hr = 9; $hr < 22; $hr++)
												echo '<option value="' . $hr . '" '.(date('H', strtotime($curusr->creneau_end)) == $hr ? 'selected="selected"' : '').'>' . $hr . 'h</option>';
											?>
										</select>
									</div>
								</div>
							<?php } */ ?>
							<div class="form-group">
								<label for="raison_sociale" class="col-md-3 control-label">Raison sociale</label>
								<div class="col-md-9">
									<input type="text" placeholder="Saisissez la raison sociale..." class="form-control" name="raison_sociale" id="raison_sociale" value="<?php echo $curusr->raison_sociale; ?>">
									<span class="help-block">Pour les sociétés uniquement</span>
								</div>
							</div>
							<div class="form-group">
								<label for="adr1" class="col-md-3 control-label">Adresse</label>
								<div class="col-md-9">
									<input type="text" placeholder="Saisissez l'adresse..." class="form-control" name="adr1" id="adr1" value="<?php echo $curusr->adr1; ?>">
								</div>
							</div>
							<div class="form-group">
								<label for="adr2" class="col-md-3 control-label">Compl. adresse</label>
								<div class="col-md-9">
									<input type="text" placeholder="Complément d'adresse..." class="form-control" name="adr2" id="adr2" value="<?php echo $curusr->adr2; ?>">
								</div>
							</div>
							<div class="form-group">
								<label for="post_code" class="col-md-3 control-label">Code postal</label>
								<div class="col-md-6">
									<input type="text" placeholder="Saisissez le code postal..." class="form-control" name="post_code" id="post_code" value="<?php echo $curusr->post_code; ?>">
								</div>
							</div>
							<div class="form-group">
								<label for="city" class="col-md-3 control-label">Ville</label>
								<div class="col-md-9">
									<input type="text" placeholder="Saisissez la ville..." class="form-control" name="city" id="city" value="<?php echo $curusr->city; ?>">
								</div>
							</div>
							<div class="form-group">
								<label for="dept" class="col-md-3 control-label">Département</label>
								<div class="col-md-9">
									<input type="text" placeholder="Saisissez le département..." class="form-control" name="dept" id="dept" value="<?php echo $curusr->dept; ?>">
								</div>
							</div>
							<div class="form-group">
								<label for="tel1" class="col-md-3 control-label">Tél principale <span class="text-danger">*</span></label>
								<div class="col-md-9">
									<input type="text" placeholder="Saisissez le téléphone principale..." class="form-control" name="tel1" id="tel1" value="<?php echo $curusr->tel1; ?>" required>
								</div>
							</div>
							<div class="form-group">
								<label for="tel2" class="col-md-3 control-label">Tél secondaire</label>
								<div class="col-md-9">
									<input type="text" placeholder="Téléphone supplementaire..." class="form-control" name="tel2" id="tel2" value="<?php echo $curusr->tel2; ?>">
								</div>
							</div>
							<div class="form-group">
								<label for="email" class="col-md-3 control-label">Email</label>
								<div class="col-md-9">
									<input type="email" placeholder="Saisissez l'adresse email..." class="form-control" name="email" id="email" value="<?php echo $curusr->email; ?>">
								</div>
							</div>
							<?php if (!CrmUser::isTelepro($currentUser)) { ?>
								<div class="form-group">
									<label for="id_crmuser" class="col-md-3 control-label">Téléopérateur</label>
									<div class="col-md-9">
										<select data-placeholder="Choisissez le télépro..." class="select-chosen" id="id_crmuser" name="id_crmuser" class="form-control" <?php echo CrmUser::isConfirmateur($currentUser) ? 'disabled="disabled"' : ''; ?>>
											<option value=""></option>
											<?php
											$cusers = CrmUser::getAll(!CrmUser::isAdmin($currentUser) ? array('id_team' => $currentUser->id_team) : '');
											if ($cusers) {
												foreach ($cusers as $cuser) {
													if (CrmUser::isTelepro($cuser) || CrmUser::isConfirmateur($cuser) || CrmUser::isManager($cuser))
														echo '<option value="' . $cuser['id_crmuser'] . '" ' . ($cuser['id_crmuser'] == $curusr->id_crmuser ? 'selected="selected"' : '') . '>' . $cuser['user_name'] . '</option>';
												}
											}
											?>
										</select>
									</div>
								</div>
							<?php } ?>

							<?php if (!CrmUser::isTelepro($currentUser) && !CrmUser::isManager($currentUser)) { ?>
								<div class="form-group">
									<label for="id_crmuser_conf" class="col-md-3 control-label">Confirmateur</label>
									<div class="col-md-9">
										<select data-placeholder="Choisissez le confirmateur..." class="select-chosen" id="id_crmuser_conf" name="id_crmuser_conf" class="form-control">
											<option value=""></option>
											<?php
											//$arrwh = array('id_profil' => '4');
											$arrwh = array();
											if (!CrmUser::isAdmin($currentUser) && !CrmUser::isConfPlus($currentUser))
												$arrwh['id_team'] = $currentUser->id_team;
											$cusers = CrmUser::getAll($arrwh);
											if ($cusers) {
												foreach ($cusers as $cuser) {
													if (CrmUser::isConfirmateur($cuser))
														echo '<option value="' . $cuser['id_crmuser'] . '" ' . ($cuser['id_crmuser'] == $curusr->id_crmuser_conf ? 'selected="selected"' : '') . '>' . $cuser['user_name'] . '</option>';
												}
											}
											?>
										</select>
									</div>
								</div>
							<?php } ?>
							
							<div class="form-group">
								<label for="source" class="col-md-3 control-label">Source <span class="text-danger">*</span></label>
								<div class="col-md-9">
									<input type="text" placeholder="Saisissez la source..." class="form-control" name="source" id="source" value="<?php echo $curusr->source; ?>" <?php echo CrmUser::isTelepro($currentUser) || CrmUser::isManager($currentUser) ? 'readonly="readonly"' : ''; ?>>
								</div>
							</div>
							<div class="form-group">
								<label for="campain" class="col-md-3 control-label">Campagne</label>
								<div class="col-md-9">
									<select class="form-control" name="campain" id="campain">
										<option value=""></option>
										<?php
											$camps = Setting::getCampains();
											if ($camps && $camps->num_rows > 0) {
												foreach($camps as $camp)
													echo '<option value="'.$camp['name_campain'].'" '.($curusr->campain == $camp['name_campain'] ? 'selected="selected"' : '').'>'.$camp['name_campain'].'</option>';
											}
										?>
									</select>
								</div>
							</div>
							<div class="form-group">
								<label for="date_create" class="col-md-3 control-label">Date création</label>
								<div class="col-md-6">
									<input type="text" class="form-control" name="date_create" id="date_create" disabled="" value="<?php echo $curusr->date_create > 0 ? date('d/m/Y H:i', strtotime($curusr->date_create)) : ''; ?>">
								</div>
							</div>
							<div class="form-group">
								<label for="date_update" class="col-md-3 control-label">Date modif.</label>
								<div class="col-md-6">
									<input type="text" class="form-control" name="date_update" id="date_update" disabled="" value="<?php echo $curusr->date_update > 0 ? date('d/m/Y H:i', strtotime($curusr->date_update)) : ''; ?>">
								</div>
							</div>
							<div class="form-group">
								<label for="date_valid" class="col-md-3 control-label">Date validation</label>
								<div class="col-md-6">
									<input type="text" class="form-control" name="date_valid" id="date_valid" <?php echo CrmUser::isTelepro($currentUser) ? 'disabled=""' : ''; ?> value="<?php echo $curusr->date_valid > 0 ? date('d/m/Y H:i', strtotime($curusr->date_valid)) : ''; ?>">
								</div>
							</div>
							<div class="form-group">
								<label for="date_install" class="col-md-3 control-label">Date install.</label>
								<div class="col-md-6">
									<input type="text" class="form-control" name="date_install" id="date_install" <?php echo CrmUser::isTelepro($currentUser) ? 'disabled=""' : ''; ?> value="<?php echo $curusr->date_install > 0 ? date('d/m/Y H:i', strtotime($curusr->date_install)) : ''; ?>">
								</div>
							</div>

							<input type="hidden" name="geolat" id="geolat" value="<?php echo $curusr->geolat; ?>" />
							<input type="hidden" name="geolng" id="geolng" value="<?php echo $curusr->geolng; ?>" />
							<input type="hidden" name="action" id="action" value="update-contact" />
							<input type="hidden" name="id_contact" id="id_contact" value="<?php echo $_GET['id_contact']; ?>" />
							<!-- END Normal Form Content -->

							<div class="form-group form-actions">
								<button class="btn btn-sm btn-primary" type="submit" id="btupdateusr"><i class="fa fa-user"></i> Valider</button>
								<button class="btn btn-sm btn-warning" type="reset"><i class="fa fa-repeat"></i> Annuler</button>
							</div>
						</fieldset>	
					</form>
				</div>
			</div>


			<div class="col-lg-8">
				<?php if ($curusr) { ?>
					<ul data-toggle="tabs" class="nav nav-tabs push">
						<?php /* <li class="active"><a href="#tabs-fin"><i class="fa fa-usd"></i> Informations fiscales</a></li> */ ?>
						<li class="active"><a href="#tabs-dir"><i class="gi gi-settings"></i> Chantier</a></li>
						<li class=""><a href="#tabs-quest"><i class="fa fa-book"></i> Questionnaire</a></li>
						<li class=""><a href="#tabs-coment"><i class="fa fa-comment-o"></i> Commentaires <span class="badge" id="nbcomment"><?php echo $comments && $comments->num_rows > 0 ? $comments->num_rows : ''; ?></span></a></li>
						<li class=""><a href="#tabs-local"><i class="fa fa-globe"></i> Localisation</a></li>
						<li class=""><a href="#tabs-rdv"><i class="fa fa-calendar"></i> Rendez vous (pose)</a></li>
						<?php if (!CrmUser::isTelepro($currentUser) && !CrmUser::isManager($currentUser)) { ?>							
							<?php if ($rdvs && $rdvs->num_rows > 0) { ?>
								<li class=""><a href="#tabs-sav"><i class="fa fa-life-saver"></i> Rendez vous (post visite)</a></li>
							<?php }  ?>
							<li class=""><a href="#tabs-cadastre"><i class="gi gi-screenshot"></i> Cadastre</a></li>
							<li class=""><a href="#tabs-doc"><i class="fa fa-file-picture-o"></i> Documents <span class="badge" id="nbdoc"><?php echo $docs && $docs->num_rows > 0 ? $docs->num_rows : ''; ?></span></a></li>
							<li class=""><a href="#tabs-prox"><i class="fa fa-location-arrow"></i> Clients à proximité</a></li>
							<li class=""><a href="#tabs-log"><i class="fi fi-log"></i> LOG</a></li>
							<li class=""><a href="#tabs-audit"><i class="fa fa-server"></i> Audit</a></li>
						<?php } ?>
					</ul>
					<div class="tab-content">

						<?php /*	
						<div id="tabs-fin" class="tab-pane active">
							<div class="block">
								<div class="block-title">
									<h2>Informations <strong>fiscales</strong></h2>
								</div>
								<form onsubmit="return false;" class="form-bordered form-horizontal" method="post" action="crmajax.php" id="frminfofisc" style="margin-top: 0px;">
									<fieldset>
										<div class="col-md-12">
											<table class="table table-striped table-vcenter table-condensed table-hover">
												<tr>
													<th>&nbsp;</th>
													<th>Numéro fiscal</th>
													<th>Référence avis</th>
												</tr>
												<tr>
													<td>Avis 1</td>
													<td><input type="text" placeholder="Saisissez le Numéro fiscal du premier avis d'imposition..." class="form-control" name="q_no_fiscal_1" id="q_no_fiscal_1" value="<?php echo $curusr->q_no_fiscal_1; ?>"></td>
													<td><input type="text" placeholder="Saisissez la référence d'avis d'imposition..." class="form-control" name="q_ref_avis_1" id="q_ref_avis_1" value="<?php echo $curusr->q_ref_avis_1; ?>"></td>
												</tr>
												<tr>
													<td>Avis 2</td>
													<td><input type="text" placeholder="Saisissez le Numéro fiscal du deuxieme avis d'imposition..." class="form-control" name="q_no_fiscal_2" id="q_no_fiscal_2" value="<?php echo $curusr->q_no_fiscal_2; ?>"></td>
													<td><input type="text" placeholder="Saisissez la référence d'avis d'imposition..." class="form-control" name="q_ref_avis_2" id="q_ref_avis_2" value="<?php echo $curusr->q_ref_avis_2; ?>"></td>
												</tr>
												<tr>
													<td colspan="3">
														<a href="#" class="btn btn-sm btn-success pull-left btviewimpot" <?php echo $curusr->q_impot_html == '' ? 'style="display:none;"' : ''; ?>>Voir la fiche fiscale des impots</a>
														<button class="btn btn-sm btn-primary pull-right" type="button" id="btsyncfiscct"><i class="fa fa-repeat"></i> Synchro fiscale</button>
													</td>
												</tr>
											</table>
										</div>
										<div class="form-group">
											<div class="col-md-4">
												<label class="control-label" for="revenu_fiscal">Revenu fiscal <span class="text-danger">*</span></label>
												<input type="text" placeholder="Revenu fiscal total du foyer ..." class="form-control" name="q_revenu_fiscal" id="q_revenu_fiscal" value="<?php echo $curusr->q_revenu_fiscal; ?>" required>
											</div>
											<div class="col-md-4">
												<label class="control-label" for="nb_foyer">Nombre de foyer</label>
												<input type="text" placeholder="Nombre de foyer ..." class="form-control" name="q_nb_foyer" id="q_nb_foyer" value="<?php echo $curusr->q_nb_foyer; ?>">
											</div>
											<div class="col-md-4">
												<label class="control-label" for="nb_person">Nombre de personne <span class="text-danger">*</span></label>
												<input type="text" placeholder="Nombre de personne du foyer ..." class="form-control" name="q_nb_person" id="q_nb_person" value="<?php echo $curusr->q_nb_person; ?>" required>
											</div>
										</div>
									</fieldset>
									<input type="hidden" name="action" id="action" value="update-fisc" />
									<input type="hidden" name="id_contact" id="id_contact" value="<?php echo $_GET['id_contact']; ?>" />
									<div class="form-group form-actions">
										<button class="btn btn-sm btn-primary" type="submit" id="btupdatefisc"><i class="fa fa-check"></i> Valider</button>
										<button class="btn btn-sm btn-warning" type="reset"><i class="fa fa-repeat"></i> Annuler</button>
									</div>
								</form>
							</div>
						</div>
						*/
						?>

						<div id="tabs-quest" class="tab-pane">
							<div class="block">
								<!-- Normal Form Title -->
								<div class="block-title">
									<h2><strong>Questionnaire</strong> client / prospect</h2>
								</div>
								<!-- END Normal Form Title -->

								<form onsubmit="return false;" class="form-bordered form-horizontal" method="post" action="crmajax.php" id="frminfoquest">
									<fieldset <?php echo $zonetodis ? 'disabled="disabled"' : ''; ?>>
										<div class="row">
											<div class="col-md-12">
												<fieldset>
													<legend><i class="fa fa-angle-right"></i> Général</legend>
													<div class="col-md-6">
														<div class="form-group">
															<label for="q_type_habit" class="col-md-6 control-label">Type habitation</label>
															<div class="col-md-6">
																<input type="text" placeholder="Saisissez le type d'habitation(Maison, appart ...)" class="form-control" name="q_type_habit" id="q_type_habit" value="<?php echo $curusr->q_type_habit; ?>">
															</div>
														</div>
													</div>
													<div class="col-md-6">
														<div class="form-group">
															<label class="col-md-6 control-label" for="q_type_chauf">Type de chauffage</label>
															<div class="col-md-6">
																<select id="q_type_chauf" name="q_type_chauf" class="form-control">
																	<option value="">--</option>
																	<?php
																	foreach (Setting::$typechauf as $tc)
																		echo '<option value="' . $tc . '" ' . ($curusr->q_type_chauf == $tc ? 'selected="selected"' : '') . '>' . $tc . '</option>';
																	?>
																</select>
															</div>
														</div>
													</div>
													<div class="col-md-6">
														<div class="form-group">
															<label class="col-md-6 control-label" for="q_occupation">Nature occupation</label>
															<div class="col-md-6">
																<select id="q_occupation" name="q_occupation" class="form-control">
																	<option value="">--</option>
																	<option value="Propriétaire" <?php echo $curusr->q_occupation == 'Propriétaire' ? 'selected="selected"' : ''; ?>>Propriétaire</option>
																	<option value="Locataire" <?php echo $curusr->q_occupation == 'Locataire' ? 'selected="selected"' : ''; ?>>Locataire</option>
																</select>
															</div>
														</div>
													</div>
													<div class="col-md-6">
														<div class="form-group">
															<label class="col-md-6 control-label" for="q_plus2an">Maison + de 2 ans</label>
															<div class="col-md-6">
																<select id="q_plus2an" name="q_plus2an" class="form-control">
																	<option value="0">--</option>
																	<option value="2" <?php echo $curusr->q_plus2an == 1 ? 'selected="selected"' : ''; ?>>Oui</option>
																	<option value="1" <?php echo $curusr->q_plus2an == 0 ? 'selected="selected"' : ''; ?>>Non</option>
																</select>
															</div>
														</div>
													</div>
												</fieldset>
											</div>

											<div class="col-md-12">
												<fieldset>
													<legend><i class="fa fa-angle-right"></i> Combles</legend>
													<div class="col-md-6">
														<div class="form-group">
															<label for="q_taille_trappe_cm" class="col-md-6 control-label">Taille de la trappe en cm</label>
															<div class="col-md-6">
																<input type="text" placeholder="Saisissez la taille de la trappe en cm..." class="form-control" name="q_taille_trappe_cm" id="q_taille_trappe_cm" value="<?php echo $curusr->q_taille_trappe_cm; ?>">
															</div>
														</div>
													</div>
													<div class="col-md-6">
														<div class="form-group">
															<label for="q_plancher_sol" class="col-md-6 control-label">Existe il un plancher au sol</label>
															<div class="col-md-6">
																<select id="q_plancher_sol" name="q_plancher_sol" class="form-control">
																	<option value="">--</option>
																	<option value="1" <?php echo $curusr->q_plancher_sol == 1 ? 'selected="selected"' : ''; ?>>Oui</option>
																	<option value="0" <?php echo $curusr->q_plancher_sol == 0 ? 'selected="selected"' : ''; ?>>Non</option>
																</select>
															</div>
														</div>
													</div>
													<div class="col-md-6">
														<div class="form-group">
															<label for="q_type_plancher" class="col-md-6 control-label">Type de plancher</label>
															<div class="col-md-6">
																<select id="q_type_plancher" name="q_type_plancher" class="form-control">
																	<option value="">--</option>		
																	<option value="Dalle de beton" <?php echo $curusr->q_type_plancher == 'Dalle de beton' ? 'selected="selected"' : ''; ?>>Dalle de beton</option>
																	<option value="En bois" <?php echo $curusr->q_type_plancher == 'En bois' ? 'selected="selected"' : ''; ?>>En bois</option>
																</select>
															</div>
														</div>
													</div>
													<div class="col-md-6">
														<div class="form-group">
															<label for="q_laine_plancher" class="col-md-6 control-label">Laine sur le plancher de vos combles</label>
															<div class="col-md-6">
																<select id="q_laine_plancher" name="q_laine_plancher" class="form-control">
																	<option value="0">--</option>	
																	<option value="2" <?php echo $curusr->q_laine_plancher == 1 ? 'selected="selected"' : ''; ?>>Oui</option>
																	<option value="1" <?php echo $curusr->q_laine_plancher == 0 ? 'selected="selected"' : ''; ?>>Non</option>
																</select>
															</div>
														</div>
													</div>
													<div class="col-md-6">
														<div class="form-group">
															<label for="q_type_laine" class="col-md-6 control-label">Type de laine</label>
															<div class="col-md-6">
																<select id="q_type_laine" name="q_type_laine" class="form-control">
																	<option value="">--</option>
																	<option value="Laine deroulee" <?php echo $curusr->q_type_laine == 'Laine deroulee' ? 'selected="selected"' : ''; ?>>Laine deroulee</option>
																	<option value="Flocons projetes" <?php echo $curusr->q_type_laine == 'Flocons projetes' ? 'selected="selected"' : ''; ?>>Flocons projetes</option>
																</select>
															</div>
														</div>
													</div>
													<div class="col-md-6">
														<div class="form-group">
															<label for="q_poutre_visible" class="col-md-6 control-label">Si non les poutres sont-elles visibles</label>
															<div class="col-md-6">
																<select id="q_poutre_visible" name="q_poutre_visible" class="form-control">
																	<option value="0">--</option>
																	<option value="2" <?php echo $curusr->q_poutre_visible == 1 ? 'selected="selected"' : ''; ?>>Oui</option>
																	<option value="1" <?php echo $curusr->q_poutre_visible == 0 ? 'selected="selected"' : ''; ?>>Non</option>
																</select>
															</div>
														</div>
													</div>

													<div class="col-md-6">
														<div class="form-group">
															<label for="q_comble_m2" class="col-md-6 control-label">Comble en M2</label>
															<div class="col-md-6">
																<input type="text" class="form-control" name="q_comble_m2" id="q_comble_m2" value="<?php echo $curusr->q_comble_m2; ?>" />
															</div>
														</div>
													</div>
													<div class="col-md-6">
														<div class="form-group">
															<label for="q_type_laine_amettre" class="col-md-6 control-label">Type de laine à mettre</label>
															<div class="col-md-6">
																<select id="q_type_laine_amettre" name="q_type_laine_amettre" class="form-control">
																	<option value="">--</option>
																	<option value="Soufflé" <?php echo $curusr->q_type_laine_amettre == 'Soufflé' ? 'selected="selected"' : ''; ?>>Soufflé</option>
																	<option value="Déroulé" <?php echo $curusr->q_type_laine_amettre == 'Déroulé' ? 'selected="selected"' : ''; ?>>Déroulé</option>
																</select>
															</div>
														</div>
													</div>

													<div class="col-md-6">
														<div class="form-group">
															<label for="q_pas_laine_plancher" class="col-md-6 control-label">Si pas laine sur plancher</label>
															<div class="col-md-6">
																<select id="q_pas_laine_plancher" name="q_pas_laine_plancher" class="form-control">
																	<option value="">--</option>
																	<option value="-8 ans" <?php echo $curusr->q_pas_laine_plancher == '-8 ans' ? 'selected="selected"' : ''; ?>>-8 ans</option>
																	<option value="+8 ans" <?php echo $curusr->q_pas_laine_plancher == '+8 ans' ? 'selected="selected"' : ''; ?>>+8 ans</option>
																</select>
															</div>
														</div>
													</div>
												</fieldset>
											</div>
											<div class="col-md-12">
												<fieldset>
													<legend><i class="fa fa-angle-right"></i> Cave</legend>
													<div class="col-md-6">
														<div class="form-group">
															<label for="q_cave_soussol" class="col-md-6 control-label">Possédez vous une cave ou un sous sol ou un vide sanitaire ?</label>
															<div class="col-md-6">
																<select id="q_cave_soussol" name="q_cave_soussol" class="form-control">
																	<option value="0">--</option>
																	<option value="2" <?php echo $curusr->q_cave_soussol == 1 ? 'selected="selected"' : ''; ?>>Oui</option>
																	<option value="1" <?php echo $curusr->q_cave_soussol == 0 ? 'selected="selected"' : ''; ?>>Non</option>
																</select>
															</div>
														</div>
													</div>
													<div class="col-md-6">
														<div class="form-group">
															<label for="q_acces_passage" class="col-md-6 control-label">l'acces ou passage est il de</label>
															<div class="col-md-6">
																<select id="q_acces_passage" name="q_acces_passage" class="form-control">
																	<option value="">--</option>
																	<option value="- 1.20 m" <?php echo $curusr->q_acces_passage == '- 1.20 m' ? 'selected="selected"' : ''; ?>>- 1.20 m</option>
																	<option value="+ 1.20 m" <?php echo $curusr->q_acces_passage == '+ 1.20 m' ? 'selected="selected"' : ''; ?>>+ 1.20 m</option>
																</select>
															</div>
														</div>
													</div>
													<div class="col-md-6">
														<div class="form-group">
															<label for="q_exist_polystyrene_cave" class="col-md-6 control-label">Y a t-il déjà du polystyrène ?</label>
															<div class="col-md-6">
																<select id="q_exist_polystyrene_cave" name="q_exist_polystyrene_cave" class="form-control">
																	<option value="0">--</option>
																	<option value="2" <?php echo $curusr->q_exist_polystyrene_cave == 1 ? 'selected="selected"' : ''; ?>>Oui</option>
																	<option value="1" <?php echo $curusr->q_exist_polystyrene_cave == 0 ? 'selected="selected"' : ''; ?>>Non</option>
																</select>
															</div>
														</div>
													</div>

													<div class="col-md-6">
														<div class="form-group">
															<label for="q_espace_chauffe" class="col-md-6 control-label">Espace chauffé</label>
															<div class="col-md-6">
																<select id="q_espace_chauffe" name="q_espace_chauffe" class="form-control">
																	<option value="0">--</option>
																	<option value="2" <?php echo $curusr->q_espace_chauffe == 1 ? 'selected="selected"' : ''; ?>>Oui</option>
																	<option value="1" <?php echo $curusr->q_espace_chauffe == 0 ? 'selected="selected"' : ''; ?>>Non</option>
																</select>
															</div>
														</div>
													</div>
													<div class="col-md-6">
														<div class="form-group">
															<label for="q_chaudiere" class="col-md-6 control-label">Y a t il une chaudiere</label>
															<div class="col-md-6">
																<select id="q_chaudiere" name="q_chaudiere" class="form-control">
																	<option value="0">--</option>
																	<option value="2" <?php echo $curusr->q_chaudiere == 1 ? 'selected="selected"' : ''; ?>>Oui</option>
																	<option value="1" <?php echo $curusr->q_chaudiere == 0 ? 'selected="selected"' : ''; ?>>Non</option>
																</select>
															</div>
														</div>
													</div>

													<div class="col-md-6">
														<div class="form-group">
															<label for="q_tuyau_plafond_cave" class="col-md-6 control-label">Y a t il de la tuyauterie au plafond de la cave</label>
															<div class="col-md-6">
																<select id="q_tuyau_plafond_cave" name="q_tuyau_plafond_cave" class="form-control">
																	<option value="0">--</option>
																	<option value="2" <?php echo $curusr->q_tuyau_plafond_cave == 1 ? 'selected="selected"' : ''; ?>>Oui</option>
																	<option value="1" <?php echo $curusr->q_tuyau_plafond_cave == 0 ? 'selected="selected"' : ''; ?>>Non</option>
																</select>
															</div>
														</div>
													</div>
													<div class="col-md-6">
														<div class="form-group">
															<label for="q_mlineair_tuyau" class="col-md-6 control-label">Si oui, nombre de m linéaire de tuyau ?</label>
															<div class="col-md-6">
																<input type="text" class="form-control" name="q_mlineair_tuyau" id="q_mlineair_tuyau" value="<?php echo $curusr->q_mlineair_tuyau; ?>" />
															</div>
														</div>
													</div>
													<div class="col-md-6">
														<div class="form-group">
															<label for="q_voyez_plafond_parking" class="col-md-6 control-label">Quand vous regardez votre plafond de parking vous voyez</label>
															<div class="col-md-6">
																<select id="q_voyez_plafond_parking" name="q_voyez_plafond_parking" class="form-control">
																	<option value="">--</option>
																	<option value="Des hourdis" <?php echo $curusr->q_voyez_plafond_parking == 'Des hourdis' ? 'selected="selected"' : ''; ?>>Des hourdis</option>
																	<option value="Des briques rouges creuses" <?php echo $curusr->q_voyez_plafond_parking == 'Des briques rouges creuses' ? 'selected="selected"' : ''; ?>>Des briques rouges creuses</option>
																	<option value="Poutre en bois" <?php echo $curusr->q_voyez_plafond_parking == 'Poutre en bois' ? 'selected="selected"' : ''; ?>>Poutre en bois</option>
																	<option value="Des hourdis en polystyrène" <?php echo $curusr->q_voyez_plafond_parking == 'Des hourdis en polystyrène' ? 'selected="selected"' : ''; ?>>Des hourdis en polystyrène</option>
																	<option value="Polystyrène existant" <?php echo $curusr->q_voyez_plafond_parking == 'Polystyrène existant' ? 'selected="selected"' : ''; ?>>Polystyrène existant</option>
																	<option value="Placoplatre" <?php echo $curusr->q_voyez_plafond_parking == 'Placoplatre' ? 'selected="selected"' : ''; ?>>Placoplatre</option>
																</select>
															</div>
														</div>
													</div>

													<div class="col-md-6">
														<div class="form-group">
															<label for="q_bois_apparente" class="col-md-6 control-label">Si Bois, apparente ?</label>
															<div class="col-md-6">
																<select id="q_bois_apparente" name="q_bois_apparente" class="form-control">
																	<option value="0">--</option>
																	<option value="2" <?php echo $curusr->q_bois_apparente == 1 ? 'selected="selected"' : ''; ?>>Oui</option>
																	<option value="1" <?php echo $curusr->q_bois_apparente == 0 ? 'selected="selected"' : ''; ?>>Non</option>
																</select>
															</div>
														</div>
													</div>
													<div class="col-md-6">
														<div class="form-group">
															<label for="q_polystyrene_lineair" class="col-md-6 control-label">Si Polystyrène, linéaire ?</label>
															<div class="col-md-6">
																<select id="q_polystyrene_lineair" name="q_polystyrene_lineair" class="form-control">
																	<option value="0">--</option>
																	<option value="2" <?php echo $curusr->q_polystyrene_lineair == 1 ? 'selected="selected"' : ''; ?>>Oui</option>
																	<option value="1" <?php echo $curusr->q_polystyrene_lineair == 0 ? 'selected="selected"' : ''; ?>>Non</option>
																</select>
															</div>
														</div>
													</div>
													<div class="col-md-6">
														<div class="form-group">
															<label for="q_epaisseur_polystyrene_plafond" class="col-md-6 control-label">Si Polystyrène, épaisseur ?</label>
															<div class="col-md-6">
																<input type="text" class="form-control" name="q_epaisseur_polystyrene_plafond" id="q_epaisseur_polystyrene_plafond" value="<?php echo $curusr->q_epaisseur_polystyrene_plafond; ?>" />
															</div>
														</div>
													</div>
													<div class="col-md-6">
														<div class="form-group">
															<label for="q_espace_voute" class="col-md-6 control-label">Espace vouté</label>
															<div class="col-md-6">
																<select id="q_espace_voute" name="q_espace_voute" class="form-control">
																	<option value="0">--</option>
																	<option value="2" <?php echo $curusr->q_espace_voute == 1 ? 'selected="selected"' : ''; ?>>Oui</option>
																	<option value="1" <?php echo $curusr->q_espace_voute == 0 ? 'selected="selected"' : ''; ?>>Non</option>
																</select>
															</div>
														</div>
													</div>
													<div class="col-md-6">
														<div class="form-group">
															<label for="q_poser_poly_10cm" class="col-md-6 control-label">Poser un polystyrène de 10cm d’épaisseur</label>
															<div class="col-md-6">															
																<select id="q_poser_poly_10cm" name="q_poser_poly_10cm" class="form-control">
																	<option value="0">--</option>
																	<option value="2" <?php echo $curusr->q_poser_poly_10cm == 1 ? 'selected="selected"' : ''; ?>>Ok</option>
																	<option value="1" <?php echo $curusr->q_poser_poly_10cm == 0 ? 'selected="selected"' : ''; ?>>Pas ok</option>
																</select>
															</div>
														</div>
													</div>

												</fieldset>
											</div>
											<div class="col-md-12">
												<fieldset>
													<legend><i class="fa fa-angle-right"></i> Mur Mitoyen</legend>
													<div class="col-md-6">
														<div class="form-group">
															<label for="q_mur_mitoyen_encombre" class="col-md-6 control-label">Votre mur mitoyen est il encombre</label>
															<div class="col-md-6">
																<select id="q_mur_mitoyen_encombre" name="q_mur_mitoyen_encombre" class="form-control">
																	<option value="0">--</option>
																	<option value="2" <?php echo $curusr->q_mur_mitoyen_encombre == 1 ? 'selected="selected"' : ''; ?>>Oui</option>
																	<option value="1" <?php echo $curusr->q_mur_mitoyen_encombre == 0 ? 'selected="selected"' : ''; ?>>Non</option>
																</select>
															</div>
														</div>
													</div>
													<div class="col-md-6">
														<div class="form-group">
															<label for="q_si_mur_encombre" class="col-md-6 control-label">Si mur encombre</label>
															<div class="col-md-6">
																<select id="q_si_mur_encombre" name="q_si_mur_encombre" class="form-control">
																	<option value="">--</option>
																	<option value="Tableau electrique" <?php echo $curusr->q_si_mur_encombre == 'Tableau electrique' ? 'selected="selected"' : ''; ?>>Tableau electrique</option>
																	<option value="Chaudiere" <?php echo $curusr->q_si_mur_encombre == 'Chaudiere' ? 'selected="selected"' : ''; ?>>Chaudiere</option>
																	<option value="Meubles / electromenager" <?php echo $curusr->q_si_mur_encombre == 'Meubles / electromenager' ? 'selected="selected"' : ''; ?>>Meubles / electromenager</option>
																</select>
															</div>
														</div>
													</div>
													<div class="col-md-6">
														<div class="form-group">
															<label for="q_taille_mur_mitoyen_m2" class="col-md-6 control-label">Taille du mur mitoyen en m2</label>
															<div class="col-md-6">
																<input type="text" placeholder="Saisissez la taille du mur mitoyen en m2..." class="form-control" name="q_taille_mur_mitoyen_m2" id="q_taille_mur_mitoyen_m2" value="<?php echo $curusr->q_taille_mur_mitoyen_m2; ?>">
															</div>
														</div>
													</div>
												</fieldset>
											</div>
										</div>

										<input type="hidden" name="action" id="action" value="update-quest" />
										<input type="hidden" name="id_contact" id="id_contact" value="<?php echo $_GET['id_contact']; ?>" />
										<div class="form-group form-actions">
											<button class="btn btn-sm btn-primary" type="submit" id="btupdateusr"><i class="fa fa-user"></i> Valider</button>
											<button class="btn btn-sm btn-warning" type="reset"><i class="fa fa-repeat"></i> Annuler</button>
										</div>
									</fieldset>
								</form>
							</div>
						</div>

						<div id="tabs-coment" class="tab-pane">
							<div class="block">
								<div class="block-title">
									<h2><strong>Commentaires</strong> Commerciaux</h2>
								</div>
								<div class="table-responsive">
									<table id="tbclimsg" class="table table-striped table-bordered table-vcenter table-condensed table-hover">
										<?php if ($comments && $comments->num_rows > 0) { ?>
											<tr>
												<th class="text-center">Date</th>
												<th class="text-center">Message</th>
												<th class="text-center">&nbsp;</th>
											</tr>
											<?php
											foreach ($comments as $comment) {
												?>
												<tr>
													<td class="text-center">
														<i class="fa fa-calendar"></i> <?php echo date('d/m/Y H:i', strtotime($comment['date_comment'])); ?>
														<?php if ($comment['user_name'] != '') { ?>
															<br><i class="fa fa-user"></i> <em> par <?php echo $comment['user_name']; ?></em>
														<?php } ?>
													</td>
													<td class="text-center"><?php echo $comment['type_comment'] == '1' ? '<i class="gi gi-alarm"></i>' . $comment['text_comment'] : $comment['text_comment']; ?></td>
													<td class="text-center">
														<div class="btn-group">
															<a href="#" data-toggle="tooltip" title="Supprimer le <?php echo $comment['type_comment'] == '0' ? 'commentaire' : 'rappel'; ?>" class="btn btn-xs btn-danger btdelcomment" data-id="<?php echo $comment['id_comment']; ?>"><i class="fa fa-trash"></i></a>
														</div>
													</td>
												</tr>
											<?php
										}
										?>
										<?php } ?>
									</table>
								</div>
								<form onsubmit="return false;" class="form-bordered form-horizontal" method="post" action="crmajax.php" id="frmaddcomment">
									<div class="row" style="margin-top:20px">
										<div class="col-md-12 col-lg-12">
											<div class="form-group">
												<div class="col-md-12">
													<textarea placeholder="Nouveau commentaire sur le client..." class="form-control" name="comment" id="comment" style="height:200px;"></textarea>
												</div>
											</div>
											<div class="col-md-12 form-group form-actions">
												<input type="hidden" name="id_contact" id="id_contact" value="<?php echo $_GET['id_contact']; ?>" />
												<input type="hidden" name="action" id="action" value="add-comment" />
												<a href="#" class="btn btn-sm btn-success pull-left" id="btaddrecall"><i class="fa fa-plus"></i> Créer un rappel pour ce client</a>&nbsp;
												<button class="btn btn-sm btn-primary pull-right" type="submit" id="btaddcomment"><i class="fa fa-plus"></i> Ajouter un commentaire</button>
											</div>
										</div>
									</div>
								</form>
							</div>
							<?php if (CrmUser::isAdmin($currentUser) || CrmUser::isConfirmateur($currentUser)) { ?>
								<div class="block">
									<div class="block-title">
										<h2><strong>Commentaires</strong> Chantier</h2>
									</div>
									<form onsubmit="return false;" class="form-bordered form-horizontal" method="post" action="crmajax.php" id="frmcomchantier">
										<div class="row" style="margin-top:20px">
											<div class="col-md-12 col-lg-12">
												<div class="form-group">
													<div class="col-md-12">
														<textarea placeholder="Insérez les commentaires chantier concernant le client..." class="form-control" name="comment" id="commentch" style="height:200px;"><?php echo $curusr->comment; ?></textarea>
													</div>
												</div>
												<div class="col-md-12 form-group form-actions">
													<input type="hidden" name="id_contact" id="id_contact" value="<?php echo $_GET['id_contact']; ?>" />
													<input type="hidden" name="action" id="action" value="update-comment-chantier" />
													<button class="btn btn-sm btn-primary pull-right" type="submit" id="btaddcomchantier"><i class="fa fa-plus"></i> Valider le commentaire chantier</button>
												</div>
											</div>
										</div>
									</form>
								</div>	
							<?php } ?>						
						</div>

						<div id="tabs-dir" class="tab-pane active">
							<div class="block">
								<!-- Normal Form Title -->
								<div class="block-title">
									<h2><strong>Chantier</strong> client</h2>
									<?php if (CrmUser::isAdmin($currentUser) || CrmUser::isConfirmateur($currentUser)) { ?>
										<div class="block-options pull-right" id="optgen" <?php echo !$prest ? 'style="display:none;"' : ''; ?>>
											<span class="label label-primary">REF: <?php echo $prest->id_prestation; ?></span>
										</div>
									<?php } ?>
								</div>
								<!-- END Normal Form Title -->


								<div class="row text-center" id="rowinfosum" <?php echo !$prest ? 'style="display:none;"' : ''; ?>>
									<div class="col-sm-6 col-lg-3">
										<a href="javascript:void(0)" class="widget widget-hover-effect2">
											<div class="widget-extra themed-background">
												<h5 class="widget-content-light"><strong>Catégorie sociale</strong></h5>
											</div>
											<div class="widget-extra-full"><span class="h4 animation-expandOpen" id="type_preca"><?php echo $prest ? Setting::$type_preca[$prest->type_preca] : ''; ?></span></div>
										</a>
									</div>
									<div class="col-sm-6 col-lg-3" data-toggle="lightbox-gallery">
										<a href="img/zones.jpg" class="widget widget-hover-effect2 gallery-link">
											<div class="widget-extra themed-background-dark">
												<h5 class="widget-content-light"><strong>Zone géographique</strong></h5>
											</div>
											<div class="widget-extra-full"><span class="h4 animation-expandOpen" id="zone"><?php echo $prest ? $prest->zone : ''; ?></span></div>
										</a>
									</div>
									<div class="col-sm-6 col-lg-3">
										<a href="javascript:void(0)" class="widget widget-hover-effect2">
											<div class="widget-extra themed-background-dark">
												<h5 class="widget-content-light"><strong>Type de chauffage</strong></h5>
											</div>
											<div class="widget-extra-full"><span class="h4 animation-expandOpen" id="type_chaufstr"><?php echo $prest ? $prest->type_chauf : ''; ?></span></div>
										</a>
									</div>
									<div class="col-sm-6 col-lg-3">
										<a href="javascript:void(0)" class="widget widget-hover-effect2">
											<div class="widget-extra themed-background-dark">
												<h5 class="widget-content-light"><strong>CUMAC</strong></h5>
											</div>
											<div class="widget-extra-full"><span class="h4 animation-expandOpen" id="cumac"><?php echo $prest ? ($prest->{'101_cumac'} + $prest->{'102_cumac'} + $prest->{'103_cumac'}) : ''; ?></span></div>
										</a>
									</div>
								</div>

								<form onsubmit="return false;" class="form-bordered form-horizontal" method="post" action="crmajax.php" id="frminfodir" style="margin-top: 0px;">
									<fieldset <?php echo $zonetodis ? 'disabled="disabled"' : ''; ?>>
										<fieldset>
											<legend>
												<i class="fa fa-info-circle"></i>
												Info fiscales
											</legend>
											<div class="col-md-12">
												<table class="table table-striped table-vcenter table-condensed table-hover">
													<tr>
														<th>&nbsp;</th>
														<th>Numéro fiscal</th>
														<th>Référence avis</th>
													</tr>
													<tr>
														<td>Avis 1</td>
														<td><input type="text" placeholder="Saisissez le Numéro fiscal du premier avis d'imposition..." class="form-control" name="no_fiscal_1" id="no_fiscal_1" value="<?php echo $prest ? $prest->no_fiscal_1 : $curusr->q_no_fiscal_1; ?>"></td>
														<td><input type="text" placeholder="Saisissez la référence d'avis d'imposition..." class="form-control" name="ref_avis_1" id="ref_avis_1" value="<?php echo $prest ? $prest->ref_avis_1 : $curusr->q_ref_avis_1; ?>"></td>
													</tr>
													<tr>
														<td>Avis 2</td>
														<td><input type="text" placeholder="Saisissez le Numéro fiscal du deuxieme avis d'imposition..." class="form-control" name="no_fiscal_2" id="no_fiscal_2" value="<?php echo $prest ? $prest->no_fiscal_2 : $curusr->q_no_fiscal_2; ?>"></td>
														<td><input type="text" placeholder="Saisissez la référence d'avis d'imposition..." class="form-control" name="ref_avis_2" id="ref_avis_2" value="<?php echo $prest ? $prest->ref_avis_2 : $curusr->q_ref_avis_2; ?>"></td>
													</tr>
													<tr>
														<td>Avis 3</td>
														<td><input type="text" placeholder="Saisissez le Numéro fiscal du troisieme avis d'imposition..." class="form-control" name="no_fiscal_3" id="no_fiscal_3" value="<?php echo $prest ? $prest->no_fiscal_3 : $curusr->q_no_fiscal_3; ?>"></td>
														<td><input type="text" placeholder="Saisissez la référence d'avis d'imposition..." class="form-control" name="ref_avis_3" id="ref_avis_3" value="<?php echo $prest ? $prest->ref_avis_3 : $curusr->q_ref_avis_3; ?>"></td>
													</tr>
													<tr>
														<td>Avis 4</td>
														<td><input type="text" placeholder="Saisissez le Numéro fiscal du quatrieme avis d'imposition..." class="form-control" name="no_fiscal_4" id="no_fiscal_4" value="<?php echo $prest ? $prest->no_fiscal_4 : $curusr->q_no_fiscal_4; ?>"></td>
														<td><input type="text" placeholder="Saisissez la référence d'avis d'imposition..." class="form-control" name="ref_avis_4" id="ref_avis_4" value="<?php echo $prest ? $prest->ref_avis_4 : $curusr->q_ref_avis_4; ?>"></td>
													</tr>
													<tr>
														<td>Avis 5</td>
														<td><input type="text" placeholder="Saisissez le Numéro fiscal du cinquieme avis d'imposition..." class="form-control" name="no_fiscal_5" id="no_fiscal_5" value="<?php echo $prest ? $prest->no_fiscal_5 : $curusr->q_no_fiscal_5; ?>"></td>
														<td><input type="text" placeholder="Saisissez la référence d'avis d'imposition..." class="form-control" name="ref_avis_5" id="ref_avis_5" value="<?php echo $prest ? $prest->ref_avis_5 : $curusr->q_ref_avis_5; ?>"></td>
													</tr>
													<tr>
														<td colspan="3">
															<a href="#" class="btn btn-sm btn-success pull-left btviewimpot" <?php echo (!$prest || $prest->impot_html == '') && $curusr->q_impot_html == '' ? 'style="display:none;"' : ''; ?>>Voir la fiche fiscale des impots</a>															
															<button class="btn btn-sm btn-primary pull-right" type="button" id="btsyncfisc"><i class="fa fa-repeat"></i> Synchro fiscale</button>
															<?php if ($isdoublonfiscal > 0) { ?>
																<strong style="position:absolute;left:0;right:0;font-size:14px;" class="text-center text-danger"><i class="fa fa-warning"></i> Attention, ces numéros fiscaux sont déja rentrés dans une autre fiche - ID : <?php echo $isdoublonfiscal; ?></strong>
															<?php } ?>
														</td>
													</tr>
												</table>
											</div>
											<div class="form-group">
												<div class="col-md-6">
													<label class="control-label" for="type_chauf">Type de chauffage</label>
													<select class="select-chosen" id="type_chauf" name="type_chauf" class="form-control">
														<?php
														foreach (Setting::$typechauf as $tc)
															echo '<option value="' . $tc . '" ' . ($prest ? ($prest->type_chauf == $tc ? 'selected="selected"' : '') : ($curusr->q_type_chauf == $tc ? 'selected="selected"' : '')) . '>' . $tc . '</option>';
														?>
													</select>
												</div>
												<div class="col-md-6">
													<label class="control-label" for="occupation">Nature occupation</label>
													<select class="select-chosen" id="occupation" name="occupation" class="form-control">
														<option value="Propriétaire" <?php echo $prest ? ($prest->occupation == 'Propriétaire' ? 'selected="selected"' : '') : ($curusr->q_occupation == 'Propriétaire' ? 'selected="selected"' : ''); ?>>Propriétaire</option>
														<option value="Locataire" <?php echo $prest ? ($prest->occupation == 'Locataire' ? 'selected="selected"' : '') : ($curusr->q_occupation == 'Locataire' ? 'selected="selected"' : ''); ?>>Locataire</option>
													</select>
												</div>
											</div>
											<div class="form-group">
												<div class="col-md-4">
													<label class="control-label" for="revenu_fiscal">Revenu fiscal <span class="text-danger">*</span></label>
													<input type="text" placeholder="Revenu fiscal total du foyer ..." class="form-control" name="revenu_fiscal" id="revenu_fiscal" value="<?php echo $prest ? $prest->revenu_fiscal : $curusr->q_revenu_fiscal; ?>" required>
												</div>
												<div class="col-md-4">
													<label class="control-label" for="nb_foyer">Nombre de foyer</label>
													<input type="text" placeholder="Nombre de foyer ..." class="form-control" name="nb_foyer" id="nb_foyer" value="<?php echo $prest ? $prest->nb_foyer : $curusr->q_nb_foyer; ?>">
												</div>
												<div class="col-md-4">
													<label class="control-label" for="nb_person">Nombre de personne <span class="text-danger">*</span></label>
													<input type="text" placeholder="Nombre de personne du foyer ..." class="form-control" name="nb_person" id="nb_person" value="<?php echo $prest ? $prest->nb_person : $curusr->q_nb_person; ?>" required>
												</div>
											</div>	
											<legend>
												<i class="fa fa-users"></i>
												Surface et matériaux
											</legend>	
											<div class="form-group">
												<div class="col-md-2">
													<label class="control-label" for="101_m2">101 <span class="text-danger">*</span></label>
													<input type="text" id="101_m2" name="101_m2" class="form-control" placeholder="Nombre M²" value="<?php echo $prest ? $prest->{'101_m2'} : ''; ?>">
												</div>
												<div class="col-md-4">
													<label class="control-label" for="id_material_101">Matériaux <span class="text-danger">*</span></label>
													<select class="select-chosen" id="id_material_101" name="id_material_101" class="form-control">
														<option value="0">Aucun</option>
														<?php
														$mats = Setting::getAllMaterials(array('type_baren' => '101'));
														if ($mats) {
															foreach ($mats as $mat) {
																echo '<option value="' . $mat['id_material'] . '" ' . ($prest && $prest->id_material_101 == $mat['id_material'] ? 'selected="selected"' : '') . '>' . $mat['name_material'] . '</option>';
															}
														}
														?>
													</select>
												</div>
												<div class="col-md-2">
													<label class="control-label" for="101_comble_perdu">Combles perdus</label><br>
													<label class="switch switch-primary"><input type="checkbox" name="101_comble_perdu" id="101_comble_perdu" <?php echo $prest && $prest->{'101_comble_perdu'} == '1' ? 'checked="true"' : ''; ?>><span></span></label>
												</div>
												<div class="col-md-2">
													<label class="control-label" for="101_rem_toiture">Rampant toiture</label><br>
													<label class="switch switch-primary"><input type="checkbox" name="101_rem_toiture" id="101_rem_toiture" <?php echo $prest && $prest->{'101_rem_toiture'} == '1' ? 'checked="true"' : ''; ?>><span></span></label>
												</div>
												<div class="col-md-2">
												</div>
											</div>
											<div class="form-group">
												<div class="col-md-2">
													<label class="control-label" for="102_m2">102 <span class="text-danger">*</span></label>
													<input type="text" id="102_m2" name="102_m2" placeholder="Nombre M²" class="form-control" value="<?php echo $prest ? $prest->{'102_m2'} : ''; ?>">
												</div>
												<div class="col-md-4">
													<label class="control-label" for="id_material_102">Matériaux <span class="text-danger">*</span></label>
													<select class="select-chosen" id="id_material_102" name="id_material_102" class="form-control">
														<option value="0">Aucun</option>
														<?php
														$mats = Setting::getAllMaterials(array('type_baren' => '102'));
														if ($mats) {
															foreach ($mats as $mat) {
																echo '<option value="' . $mat['id_material'] . '" ' . ($prest && $prest->id_material_102 == $mat['id_material'] ? 'selected="selected"' : '') . '>' . $mat['name_material'] . '</option>';
															}
														}
														?>
													</select>
												</div>
												<div class="col-md-6">
												</div>
											</div>
											<div class="form-group">
												<div class="col-md-2">
													<label class="control-label" for="103_m2">103 <span class="text-danger">*</span></label>
													<input type="text" placeholder="Nombre M²" id="103_m2" name="103_m2" class="form-control" value="<?php echo $prest ? $prest->{'103_m2'} : ''; ?>">
												</div>
												<div class="col-md-4">
													<label class="control-label" for="id_material_103">Matériaux <span class="text-danger">*</span></label>
													<select class="select-chosen" id="id_material_103" name="id_material_103" class="form-control">
														<option value="0">Aucun</option>
														<?php
														$mats = Setting::getAllMaterials(array('type_baren' => '103'));
														if ($mats) {
															foreach ($mats as $mat) {
																echo '<option value="' . $mat['id_material'] . '" ' . ($prest && $prest->id_material_103 == $mat['id_material'] ? 'selected="selected"' : '') . '>' . $mat['name_material'] . '</option>';
															}
														}
														?>
													</select>
												</div>
												<div class="col-md-2">
													<label class="control-label" for="103_colle">Besoin de colle ?</label><br>
													<label class="switch switch-primary"><input type="checkbox" name="103_colle" id="103_colle" <?php echo $prest && $prest->{'103_colle'} == '1' ? 'checked="true"' : ''; ?>><span></span></label>
												</div>
												<div class="col-md-2">
													<label class="control-label" for="103_cheville">Besoin de cheville ?</label><br>
													<label class="switch switch-primary"><input type="checkbox" name="103_cheville" id="103_cheville" <?php echo $prest && $prest->{'103_cheville'} == '1' ? 'checked="true"' : ''; ?>><span></span></label>
												</div>
												<div class="col-md-2">
												<label class="control-label" for="103_clous">Clous ?</label><br>
													<label class="switch switch-primary"><input type="checkbox" name="103_clous" id="103_clous" <?php echo $prest && $prest->{'103_clous'} == '1' ? 'checked="true"' : ''; ?>><span></span></label>
												</div>												
											</div>
										</fieldset>
										<?php if (CrmUser::isAdmin($currentUser) || CrmUser::isConfirmateur($currentUser)) { ?>
											<fieldset>
												<legend>
													<i class="fa fa-users"></i>
													Intervenants
												</legend>
												<div class="form-group">
													<div class="col-md-4">
														<label class="control-label" for="id_mandator">Maitre d'oeuvre</label>
														<select class="select-chosen" id="id_mandator" name="id_mandator" class="form-control">
															<?php
															$mands = Setting::getAllMandators();
															if ($mands) {
																foreach ($mands as $mand) {
																	echo '<option value="' . $mand['id_mandator'] . '" ' . ($prest && $prest->id_mandator == $mand['id_mandator'] ? 'selected="selected"' : '') . '>' . $mand['name_mandator'] . '</option>';
																}
															}
															?>
														</select>
													</div>
													<div class="col-md-4">
														<label class="control-label" for="id_contributor">Délégataire</label>
														<select class="select-chosen" id="id_contributor" name="id_contributor" class="form-control">
															<?php
															$conts = Setting::getAllContributors();
															if ($conts) {
																foreach ($conts as $cont) {
																	echo '<option value="' . $cont['id_contributor'] . '" ' . ($prest && $prest->id_contributor == $cont['id_contributor'] ? 'selected="selected"' : '') . '>' . $cont['name_contributor'] . '</option>';
																}
															}
															?>
														</select>
													</div>
													<div class="col-md-4">
														<label class="control-label" for="id_installator">Installateur</label>
														<select class="select-chosen" id="id_installator" name="id_installator" class="form-control">
															<?php
															$insts = Installator::getAll();
															if ($insts) {
																foreach ($insts as $inst) {
																	echo '<option value="' . $inst['id_installator'] . '" ' . ($prest && $prest->id_installator == $inst['id_installator'] ? 'selected="selected"' : '') . '>' . $inst['installator_name'] . '</option>';
																}
															}
															?>
														</select>
													</div>
												</div>										
											</fieldset>
										<?php } ?>
										<input type="hidden" name="action" id="action" value="update-dir" />
										<input type="hidden" name="id_contact" id="id_contact" value="<?php echo $_GET['id_contact']; ?>" />
										<input type="hidden" name="id_prestation" id="id_prestation" value="<?php echo $prest ? $prest->id_prestation : ''; ?>" />
										<div class="form-group form-actions">
											<button class="btn btn-sm btn-primary" type="submit" id="btupdatedir"><i class="fa fa-user"></i> Valider</button>
											<button class="btn btn-sm btn-warning" type="reset"><i class="fa fa-repeat"></i> Annuler</button>
										</div>
									</fieldset>
								</form>
							</div>
						</div>
												
						<div id="tabs-rdv" class="tab-pane">
							<?php
							$rdvs = RDV::getBy(array('r.id_contact' => $curusr->id_contact, 'type_rdv' => '0'));
							if ($rdvs && $rdvs->num_rows > 0) {
								?>
								<div class="block">
									<div class="block-title">
										<h2><strong>Rendez-Vous du </strong> client (Pose)</h2>
									</div>
									<div class="row">
										<div class="col-md-12">
											<table class="table table-striped table-vcenter table-condensed table-hover">
												<tr>
													<th>Date</th>
													<th>Entrepot</th>
													<th>Installateur</th>
													<th>Heure du RDV</th>
													<th>Créneau client</th>
													<th>Statut</th>
													<th>&nbsp;</th>
												</tr>
												<?php
												foreach ($rdvs as $rdv) {
													?>
													<tr>
														<td><?php echo Tool::fulldatestr($rdv['date_rdv']); ?></td>
														<td><a href="entrepot.php?id_entrepot=<?php echo $rdv['id_entrepot']; ?>"><?php echo $rdv['entrepot_name']; ?></a></td>
														<td><?php echo (int)$rdv['id_installator'] > 0 ? '<a href="installator.php?id_installator=' . $rdv['id_installator'] . '">' . $rdv['installator_name'] . '</a>' : 'NON RENSEIGNÉ'; ?></td>
														<td><?php echo date('H:i', strtotime($rdv['rdv_start'])) . ' - ' . date('H:i', strtotime($rdv['rdv_end'])); ?></td>
														<td><?php echo date('H:i', strtotime($rdv['creneau_start'])) . ' - ' . date('H:i', strtotime($rdv['creneau_end'])); ?></td>
														<td><?php echo (int)$rdv['status_rdv'] == 0 ? 'A confirmer' : ((int)$rdv['status_rdv'] == 1 ? 'OK Confirmé' : ((int)$rdv['status_rdv'] == 0 ? 'A Confirmer' : 'Validé')); ?></td>
														<td>
															<div class="btn-group">
																<a href="planning.php?dt=<?php echo strtotime($rdv['date_rdv']); ?>" data-toggle="tooltip" title="Voir le planning" class="btn btn-xs btn-default"><i class="fa fa-calendar"></i></a>
																<a href="tour.php?id_planning=<?php echo $rdv['id_planning']; ?>&view=1&id_rdv=<?php echo $rdv['id_rdv']; ?>" data-toggle="tooltip" title="Voir la tournée" class="btn btn-xs btn-info"><i class="fa fa-eye"></i></a>
																<?php /*if ((int)$rdv['status_rdv'] < 2 && !CrmUser::isTelepro($currentUser)) { ?>
																	<a href="#" data-toggle="tooltip" title="<?php echo (int)$rdv['status_rdv'] == 0 ? 'Confirmer' : 'Valider'; ?> le RDV" class="btn btn-xs btn-success btconfrdv" data-status="<?php echo (int)$rdv['status_rdv']; ?>" data-id="<?php echo $rdv['id_rdv']; ?>"><i class="fa fa-check"></i></a>
																<?php }*/ ?>
																<a href="#" data-toggle="tooltip" title="Annuler le RDV" class="btn btn-xs btn-danger btdelrdv" data-id="<?php echo $rdv['id_rdv']; ?>"><i class="fa fa-times"></i></a>
															</div>
														</td>
													</tr>
												<?php
											}
											?>
											</table>
										</div>
									</div>
								</div>
							<?php
							}
						?>
							<div class="block">
								<div class="block-title">
									<h2><strong>Ajouter un Rendez-Vous</strong> client (Pose)</h2>
								</div>
								<?php if ($rdvs && $rdvs->num_rows > 0) { ?>
									<div class="row">
										<div class="col-md-12">
											<h4 class="text-center text-danger">Pour ajouter un rendez-vous, supprimer d'abord le rendez vous existant.</h4>
										</div>
									</div>
								<?php } else { ?>
									<div class="block row">
										<div class="col-md-12 push">
											<div class="col-md-3">
												<label for="date_from_rdv">A partir du :</label>
												<input type="text" id="date_from_rdv" name="date_from_rdv" class="form-control input-datepicker" data-date-format="dd/mm/yyyy" placeholder="dd/mm/yyyy" value="<?php echo $curusr->date_rdv_pros > 0 ? date('d/m/Y', strtotime($curusr->date_rdv_pros)) : date('d/m/Y', time()+86400); ?>">
											</div>
											<div class="col-md-3">
												<label for="duration_rdv">Durée du rendez vous :</label>
												<select name="duration_rdv" id="duration_rdv" class="form-control">
													<?php
													for ($hr = 2; $hr < 14; $hr++)
														echo '<option value="' . $hr . '" '.($hr == 3 ? 'selected="selected"' : '').'>' . $hr . ' heures</option>';
													?>
												</select>
											</div>
											<!--
											<div class="col-md-2">
												<label for="hr_rdv">Heure désirée : <small>(Optionelle)</small></label>
												<select name="hr_rdv" id="hr_rdv" class="form-control">
													<?php
													for ($hr = 7; $hr < 21; $hr++)
														echo '<option value="' . $hr . '">' . $hr . 'h</option>';
													?>
												</select>
											</div> -->
											<div class="col-md-3">
												<label for="rdvcreneau_start">Créneau horaire <small>(Début)</small>:</label>
												<select name="rdvcreneau_start" id="rdvcreneau_start" class="form-control">
													<?php
													for ($hr = 7; $hr < 21; $hr++)
														echo '<option value="' . $hr . '">' . $hr . 'h</option>';
													?>
												</select>
											</div>
											<div class="col-md-3">
												<label for="rdvcreneau_end">Créneau horaire <small>(Fin)</small>:</label>
												<select name="rdvcreneau_end" id="rdvcreneau_end" class="form-control">
													<?php
													for ($hr = 9; $hr < 22; $hr++)
														echo '<option value="' . $hr . '">' . $hr . 'h</option>';
													?>
												</select>
											</div>
											<div class="col-md-12 text-right">
												<a href="#" class="btn btn-alt btn-sm btn-info" id="btgetrdv" style="margin: 20px auto;display: block;"><i class="fa fa-refresh"></i> Afficher les disponibilités</a>
											</div>
										</div>
									</div>
								<?php } ?>
							</div>
						</div>

						<?php if ($rdvs && $rdvs->num_rows > 0) { ?>
							<div id="tabs-sav" class="tab-pane">
								<?php
								$savs = RDV::getBy(array('r.id_contact' => $curusr->id_contact, 'type_rdv' => '1'));
								if ($savs && $savs->num_rows > 0) {
									?>
									<div class="block">
										<div class="block-title">
											<h2><strong>Rendez-Vous du </strong> client (Post visite)</h2>
										</div>
										<div class="row">
											<div class="col-md-12">
												<table class="table table-striped table-vcenter table-condensed table-hover">
													<tr>
														<th>Date</th>
														<th>Entrepot</th>
														<th>Installateur</th>
														<th>Heure du RDV</th>
														<th>Créneau client</th>
														<th>Statut</th>
														<th>Fait / Pas fait</th>
														<th>&nbsp;</th>
													</tr>
													<?php
													foreach ($savs as $sav) {
														?>
														<tr>
															<td><?php echo Tool::fulldatestr($sav['date_rdv']); ?></td>
															<td><a href="entrepot.php?id_entrepot=<?php echo $sav['id_entrepot']; ?>"><?php echo $sav['entrepot_name']; ?></a></td>
															<td><?php echo (int)$sav['id_installator'] > 0 ? '<a href="installator.php?id_installator=' . $sav['id_installator'] . '">' . $sav['installator_name'] . '</a>' : 'NON RENSEIGNÉ'; ?></td>
															<td><?php echo date('H:i', strtotime($sav['rdv_start'])) . ' - ' . date('H:i', strtotime($sav['rdv_end'])); ?></td>
															<td><?php echo date('H:i', strtotime($sav['creneau_start'])) . ' - ' . date('H:i', strtotime($sav['creneau_end'])); ?></td>															
															<td><?php echo (int)$rdv['status_rdv'] == 0 ? 'A confirmer' : ((int)$rdv['status_rdv'] == 1 ? 'OK Confirmé' : ((int)$rdv['status_rdv'] == 0 ? 'A Confirmer' : 'Validé')); ?></td>
															<td><?php echo (int)$sav['sav_done'] == 0 ? 'A effectuer' : 'Effectué'; ?></td>
															<td>
																<div class="btn-group">
																	<a href="planning.php?dt=<?php echo strtotime($sav['date_rdv']); ?>" data-toggle="tooltip" title="Voir le planning" class="btn btn-xs btn-default"><i class="fa fa-calendar"></i></a>
																	<a href="tour.php?id_planning=<?php echo $sav['id_planning']; ?>&view=1&id_rdv=<?php echo $sav['id_rdv']; ?>" data-toggle="tooltip" title="Voir la tournée" class="btn btn-xs btn-info"><i class="fa fa-eye"></i></a>
																	<a href="#" data-toggle="tooltip" title="Annuler le RDV SAV" class="btn btn-xs btn-danger btdelrdv" data-id="<?php echo $sav['id_rdv']; ?>"><i class="fa fa-times"></i></a>
																</div>
															</td>
														</tr>
													<?php
												}
												?>
												</table>
											</div>
										</div>
									</div>
								<?php
							} 
							?>
								<div class="block">
									<div class="block-title">
										<h2><strong>Ajouter un Rendez-Vous</strong> (Post visite)</h2>
									</div>
									<?php if ($savs && $savs->num_rows > 0) { ?>
										<div class="row">
											<div class="col-md-12">
												<h4 class="text-center text-danger">Pour ajouter un rendez-vous (Post visite), supprimer d'abord le rendez vous (Post visite) existant.</h4>
											</div>
										</div>
									<?php } else { ?>
										<div class="block row">
											<div class="col-md-12 push">
												<div class="col-md-3">
													<label for="date_from_sav">A partir du :</label>
													<input type="text" id="date_from_sav" name="date_from_sav" class="form-control input-datepicker" data-date-format="dd/mm/yyyy" placeholder="dd/mm/yyyy" value="<?php echo date('d/m/Y', time()+86400); ?>">
												</div>
												<div class="col-md-3">
													<label for="duration_sav">Durée du rendez vous :</label>
													<select name="duration_sav" id="duration_sav" class="form-control">
														<?php
														for ($hr = 2; $hr < 14; $hr++)
															echo '<option value="' . $hr . '" '.($hr == 3 ? 'selected="selected"' : '').'>' . $hr . ' heures</option>';
														?>
													</select>
												</div>
												<!--
												<div class="col-md-2">
													<label for="hr_rdv">Heure désirée : <small>(Optionelle)</small></label>
													<select name="hr_rdv" id="hr_rdv" class="form-control">
														<?php
														for ($hr = 7; $hr < 21; $hr++)
															echo '<option value="' . $hr . '">' . $hr . 'h</option>';
														?>
													</select>
												</div> -->
												<div class="col-md-3">
													<label for="savcreneau_start">Créneau horaire <small>(Début)</small>:</label>
													<select name="savcreneau_start" id="savcreneau_start" class="form-control">
														<?php
														for ($hr = 7; $hr < 21; $hr++)
															echo '<option value="' . $hr . '">' . $hr . 'h</option>';
														?>
													</select>
												</div>
												<div class="col-md-3">
													<label for="savcreneau_end">Créneau horaire <small>(Fin)</small>:</label>
													<select name="savcreneau_end" id="savcreneau_end" class="form-control">
														<?php
														for ($hr = 9; $hr < 22; $hr++)
															echo '<option value="' . $hr . '">' . $hr . 'h</option>';
														?>
													</select>
												</div>
												<div class="col-md-12 text-right">
													<a href="#" class="btn btn-alt btn-sm btn-info" id="btgetsav" style="margin: 20px auto;display: block;"><i class="fa fa-refresh"></i> Afficher les disponibilités</a>
												</div>
											</div>
										</div>
									<?php } ?>
								</div>
							</div>
						<?php }  ?>

						<div id="tabs-local" class="tab-pane">
							<div class="block">
								<div class="block-title">
									<h2><strong>Localisation</strong> client / prospect</h2>
								</div>
								<div class="row">
									<div class="col-md-12 col-lg-12">
										<div class="row push">
											<div id="map"></div>
										</div>
									</div>
								</div>
								<div class="row push">
									<div class="col-md-4">
										<label for="id_entrepot_near ">Entepot le plus proche</label>
										<input type="text" class="form-control" disabled="disabled" name="id_entrepot_near " id="id_entrepot_near" value="<?php echo $curusr->entrepot_name; ?>" />
									</div>
									<div class="col-md-4">
										<label for="distance_ent">Distance</label>
										<input type="text" class="form-control" disabled="disabled" name="distance_ent" id="distance_ent"  value="<?php echo $curusr->distance_ent; ?>" />
									</div>
									<div class="col-md-4">
										<label for="delay_ent">Délai</label>
										<input type="text" class="form-control" disabled="disabled" name="delay_ent" id="delay_ent"  value="<?php echo $curusr->delay_ent; ?>" />
									</div>
								</div>
							</div>
						</div>						
						
						<?php if (!CrmUser::isTelepro($currentUser) && !CrmUser::isManager($currentUser)) { ?>
							<div id="tabs-cadastre" class="tab-pane">
								<div class="block">
									<div class="block-title">
										<h2><strong>Cadastre</strong></h2>
									</div>
									<div class="row">
										<div class="col-md-12 col-lg-12">
											<div class="row push">
												<iframe id="frmcadastre" src="#" data-src="https://www.geoportail.gouv.fr/embed/visu.html?c=<?php echo $curusr->geolng . ',' . $curusr->geolat; ?>&z=20&l0=ORTHOIMAGERY.ORTHOPHOTOS::GEOPORTAIL:OGC:WMTS(1)&l1=CADASTRALPARCELS.PARCELS::GEOPORTAIL:OGC:WMTS(1)&permalink=yes" style="width:100%; height:500px;"></iframe>
											</div>
										</div>
									</div>
								</div>
							</div>

							<div id="tabs-doc" class="tab-pane">
								<div class="block">
									<div class="block-title">
										<h2><strong>Documents</strong> client / prospect</h2>
									</div>
									<form action="crmajax.php" class="dropzone" id="my-awesome-dropzone">
										<input type="hidden" name="action" id="action" value="upload-doc" />
										<input type="hidden" name="id_contact" id="id_contact" value="<?php echo $_GET['id_contact']; ?>" />
									</form>
									<div id="contentdocs" style="margin-top:20px;">
										<div class="gallery" data-toggle="lightbox-gallery">
											<div class="row">
												<?php
												if ($docs) {
													foreach ($docs as $doc) {
														if (Tool::isImage($doc['name_doc'])) {
															?>
															<div class="col-sm-3 gallery-image">
																<img src="<?php echo $template['url'] . '/uploads/' . $curusr->codekey . $curusr->id_contact . '/' . $doc['name_doc']; ?>" alt="image">
																<div class="gallery-image-options text-center">
																	<div class="btn-group btn-group-sm">
																		<a href="<?php echo $template['url'] . '/uploads/' . $curusr->codekey . $curusr->id_contact . '/' . $doc['name_doc']; ?>" class="gallery-link btn btn-sm btn-alt btn-default" title="Ajoutée <?php echo date('d/m/Y H:i', strtotime($doc['date_doc'])); ?>">Zoom</a>
																		<a href="javascript:void(0)" class="btn btn-sm btn-alt btn-default deldoc" title="Supprimer" data-id="<?php echo $doc['id_doc']; ?>"><i class="fa fa-trash"></i></a>
																	</div>
																</div>
															</div>
														<?php
													} else {
														?>
															<div class="col-sm-3 gallery-image gallery-file">
																<i class="hi hi-file"></i><br><?php echo $doc['name_doc']; ?>
																<div class="gallery-image-options text-center">
																	<div class="btn-group btn-group-sm">
																		<a href="<?php echo $template['url'] . '/uploads/' . $curusr->codekey . $curusr->id_contact . '/' . $doc['name_doc']; ?>" class="btn btn-sm btn-alt btn-default" target="new" title="Ajoutée <?php echo date('d/m/Y H:i', strtotime($doc['date_doc'])); ?>">Voir</a>
																		<a href="javascript:void(0)" class="btn btn-sm btn-alt btn-default deldoc" title="Supprimer" data-id="<?php echo $doc['id_doc']; ?>"><i class="fa fa-trash"></i></a>
																	</div>
																</div>
															</div>
														<?php
													}
												}
											}
											?>
											</div>
										</div>
									</div>
								</div>
							</div>

							<div id="tabs-prox" class="tab-pane">
								<div class="block">
									<div class="block-title">
										<h2><strong>Clients / contacts</strong> à proximité</h2>
									</div>
									<div class="table-responsive">
										<table id="tbcliprox" class="table table-vcenter table-condensed table-bordered">
											<thead>
												<tr>
													<th class="text-center">ID</th>
													<th class="text-center"><i class="gi gi-user"></i> Client</th>
													<th class="text-center">Info</th>
													<th class="text-center">Distance</th>
													<th class="text-center">Statut</th>
													<th class="text-center">Statut (Conf.)</th>
													<th class="text-center">Date RDV</th>
													<th class="text-center">&nbsp;</th>
												</tr>
											</thead>
											<tbody>
												<?php
												$proxs = Contact::getAround($curusr->id_contact, $curusr->geolat, $curusr->geolng, $sets->DISTANCE_PROX);
												foreach ($proxs as $prox) {
													?>
													<tr>
														<td class="text-center"><?php echo $prox['id_contact']; ?></td>
														<td class="text-center"><a href="contact.php?id_contact=<?php echo $prox['id_contact']; ?>"><?php echo $prox['first_name'] . ' ' . $prox['last_name']; ?></a></td>
														<td><?php echo $prox['tel1']; ?><br><small><?php echo $prox['adr1'] . ' ' . $prox['post_code'] . ' ' . $prox['city']; ?></small></td>
														<td class="text-center"><?php echo Tool::distancestr($prox['dis']); ?></td>
														<td class="text-center"><?php echo $prox['name_statuscont']; ?></td>
														<td class="text-center"><?php echo $prox['name_statuscontconf']; ?></td>
														<td class="text-center"><?php echo strtotime($prox['date_rdv']) > 0 ? date('d/m/Y', strtotime($prox['date_rdv'])) : ''; ?></td>
														<td>
															<label data-toggle="tooltip" title="<?php echo str_replace('"', "'", $prox['comments']); ?>" data-placement="left" class="label label-success">
																<?php echo $prox['nb_com']; ?> comment.
															</label>
														</td>
													</tr>
												<?php } ?>
											</tbody>
										</table>
									</div>
								</div>
							</div>

							<div id="tabs-log" class="tab-pane">
								<div class="block">
									<div class="block-title">
										<h2><strong>LOG</strong> client / prospect</h2>
									</div>
									<?php echo $outlogs; ?>
								</div>
							</div>

							<div id="tabs-audit" class="tab-pane">
								<div class="block">
									<div class="block-title">
										<h2><strong>Audit</strong> des modifications client / prospect</h2>
									</div>
									<?php echo $outaudits; ?>
								</div>
							</div>

						<?php } ?>
					</div>
				<?php } ?>
			</div> <!-- END Tabs Left block -->
		</div>
	</div>
	<!-- END eShop Overview Block -->

	<!-- Modal recall -->
	<div id="modal-recall" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<!-- Modal Header -->
				<div class="modal-header text-center">
					<h2 class="modal-title"><i class="gi gi-calendar"></i> Rappel contact / prospect</h2>
				</div>
				<!-- END Modal Header -->

				<!-- Modal Body -->
				<div class="modal-body">
					<form onsubmit="return false;" class="form-bordered form-horizontal" id="frmrecall" method="post" action="crmajax.php">
						<!-- Normal Form Content -->
						<div class="form-group">
							<label for="date_recall" class="col-md-4 control-label">Date de rappel</label>
							<div class="col-md-6">
								<input type="text" id="date_recall" name="date_recall" class="form-control input-datepicker" data-date-format="dd/mm/yyyy" placeholder="dd/mm/yyyy" value="" required>
							</div>
						</div>
						<div class="form-group">
							<label for="time_recall" class="col-md-4 control-label">Heure de rappel</label>
							<div class="col-md-6">
								<div class="input-group bootstrap-timepicker">
									<input type="text" name="time_recall" id="time_recall" value="" class="form-control input-timepicker24" required>
									<span class="input-group-btn">
										<a href="javascript:void(0)" class="btn btn-primary"><i class="fa fa-clock-o"></i></a>
									</span>
								</div>

							</div>
						</div>
						<div class="form-group form-actions">
							<div class="col-md-12 text-center">
								<input type="hidden" name="id_contact" id="id_contactrecal" value="<?php echo $_GET['id_contact']; ?>" />
								<input type="hidden" name="action" id="actionrecal" value="add-recall" />
								<button href="#" class="btn btn-sm btn-default" data-dismiss="modal">Fermer</button>
								<button class="btn btn-sm btn-primary" id="btrecall" type="submit">Valider</button>
							</div>
						</div>
					</form>
				</div>
				<!-- END Modal Body -->
			</div>
		</div>
	</div>
	<!-- END modal recall -->

	<!-- Modal info fiscale -->
	<div id="modal-impot" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<!-- Modal Header -->
				<div class="modal-header text-center">
					<h2 class="modal-title"><i class="fa fa-cogs"></i> Fiche fiscale des impots</h2>
				</div>
				<!-- END Modal Header -->

				<!-- Modal Body -->
				<div class="modal-body">
					<?php echo $prest && !empty($prest->impot_html) ? $prest->impot_html : $curusr->q_impot_html; ?>
				</div>
				<!-- END Modal Body -->
			</div>
		</div>
	</div>
	<!-- END view impot -->

	<!-- Modal Planning rendez vous -->
	<div id="modal-rdv" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog" style="width:95%;">
			<div class="modal-content">
				<!-- Modal Header -->
				<div class="modal-header text-center">
					<h2 class="modal-title"><i class="fa fa-calendar"></i> Ajout de rendez vous</h2>
				</div>
				<!-- END Modal Header -->

				<!-- Modal Body -->
				<div class="modal-body">
					<div id="calrdv"></div>
				</div>
				<!-- END Modal Body -->
			</div>
		</div>
	</div>
	<!-- END view impot -->

	<!-- Modal PDF BAR EN -->
	<div id="modal-baren" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<!-- Modal Body -->
				<div class="modal-body" style="height: 80vh">
					<iframe src="" style="width:100%;height:100%;"></iframe>
				</div>
				<!-- END Modal Body -->
			</div>
		</div>
	</div>
	<!-- END view impot -->
</div>
<!-- END Page Content -->


<?php include 'inc/page_footer.php'; ?> 

<!-- Remember to include excanvas for IE8 chart support -->
<!--[if IE 8]><script src="js/helpers/excanvas.min.js"></script><![endif]-->

<?php include 'inc/template_scripts.php'; ?>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyArKK0Hvu_FtKgyvHkUUjyKOMK2Hmt9zY0&libraries=places"></script>
<!-- Load and execute javascript code used only in this page -->
<script>
	$(document).ready(function() {
		

		$('#frminfousr').submit(function() {
			if (parseInt($('#id_statuscont').val()) == 0) {
				$.bootstrapGrowl('<h4>Erreur!</h4> <p>Veuillez renseigner le statut</p>', {
					type: 'danger',
					delay: 2500,
					allow_dismiss: true
				});
				return false;
			}

			HoldOn.open();
			jQuery(this).ajaxSubmit({
				dataType: 'json',
				success: function(resp) {
					if (resp.code == 'SUCCESS') {
						if ($('#id_contact').val() == '0') {
							$.bootstrapGrowl('<h4>Confirmation!</h4> <p>Informations contact créées</p>', {
								type: 'success',
								delay: 2500,
								allow_dismiss: true
							});
							//$('#id_contact').val(resp.id_contact);
							//$('#frminfodir input[name="id_contact"]').val(resp.id_contact);
							//$('#btupdatedir').click();
							setTimeout(function() {
								location.href = 'contact.php?id_contact=' + resp.id_contact;
							}, 1000);
						} else {
							$.bootstrapGrowl('<h4>Confirmation!</h4> <p>Modification effectuée</p>', {
								type: 'success',
								delay: 2500,
								allow_dismiss: true
							});
							setTimeout(function() {
								window.location.reload();
							}, 1000);
						}
					} else
					if (resp.code == 'ERROR')
						$.bootstrapGrowl('<h4>Erreur!</h4> <p>' + resp.message + '</p>', {
							type: 'danger',
							delay: 2500,
							allow_dismiss: true
						});
					HoldOn.close();
				},
				error: function() {
					console.log('NO');
					HoldOn.close();
				}
			});
			return false;
		});

		$('#frminfoquest').submit(function() {
			HoldOn.open();
			jQuery(this).ajaxSubmit({
				dataType: 'json',
				success: function(resp) {
					if (resp.code == 'SUCCESS') {
						$.bootstrapGrowl('<h4>Confirmation!</h4> <p>Modification effectuée</p>', {
							type: 'success',
							delay: 2500,
							allow_dismiss: true
						});
					} else
					if (resp.code == 'ERROR')
						$.bootstrapGrowl('<h4>Erreur!</h4> <p>' + resp.message + '</p>', {
							type: 'danger',
							delay: 2500,
							allow_dismiss: true
						});
					HoldOn.close();
				},
				error: function() {
					console.log('NO');
					HoldOn.close();
				}
			});
			return false;
		});


		$('#frmaddcomment').submit(function() {
			if ($('#comment').val() == '') {
				$.bootstrapGrowl('<h4>Erreur!</h4> <p>Veuillez renseigner le message à ajouter</p>', {
					type: 'danger',
					delay: 2500,
					allow_dismiss: true
				});
				return false;
			}

			HoldOn.open();
			jQuery(this).ajaxSubmit({
				dataType: 'json',
				success: function(resp) {
					if (resp.code == 'SUCCESS') {
						$('#tbclimsg').append('<tr><td class="text-center">A l\'instant</td><td class="text-center">' + resp.inits + ' : ' + $('#comment').val() + '</td><td class="text-center"><div class="btn-group"><a href="#" data-toggle="tooltip" title="Supprimer le commentaire" class="btn btn-xs btn-danger btdelcomment" data-id="' + resp.id_comment + '"><i class="fa fa-trash"></i></a></div></td></tr>');
						$('#nbcomment').text((parseInt($('#nbcomment').text()) || 0) + 1);
						$('#comment').val('');
						$("body").tooltip({
							selector: '[data-toggle="tooltip"]'
						});
					} else
					if (resp.code == 'ERROR')
						$.bootstrapGrowl('<h4>Erreur!</h4> <p>' + resp.message + '</p>', {
							type: 'danger',
							delay: 2500,
							allow_dismiss: true
						});
					HoldOn.close();
				},
				error: function() {
					console.log('NO');
					HoldOn.close();
				}
			});
			return false;
		});

		$(document).on('click', '.btdelcomment', function() {
			if (confirm('Supprimer le commentaire ?')) {
				var obj = $(this);
				HoldOn.open();
				$.post('crmajax.php', {
					action: 'delete-comment',
					id_comment: obj.attr('data-id')
				}, function(resp) {
					HoldOn.close();
					if (resp.code == 'SUCCESS') {
						obj.parents('tr').remove();
						$('#nbcomment').text((parseInt($('#nbcomment').text()) || 0) - 1);
					} else
						$.bootstrapGrowl('<h4>Erreur!</h4> <p>' + resp.message + '</p>', {
							type: 'danger',
							delay: 2500,
							allow_dismiss: true
						});

					$('.tooltip.in').remove();
				}, 'json');
			}

			return false;
		});

		$('#frmcomchantier').submit(function() {
			HoldOn.open();
			jQuery(this).ajaxSubmit({
				dataType: 'json',
				success: function(resp) {
					if (resp.code == 'SUCCESS') {
						$.bootstrapGrowl('<h4>Confirmation!</h4> <p>Informations enregistrées</p>', {
							type: 'success',
							delay: 2500,
							allow_dismiss: true
						});
					} else
					if (resp.code == 'ERROR')
						$.bootstrapGrowl('<h4>Erreur!</h4> <p>' + resp.message + '</p>', {
							type: 'danger',
							delay: 2500,
							allow_dismiss: true
						});
					HoldOn.close();
				},
				error: function() {
					console.log('NO');
					HoldOn.close();
				}
			});
			return false;
		});		

		$('#btaddrecall').click(function() {
			$('#modal-recall').modal();
			return false;
		});

		$('#frmrecall').submit(function() {
			HoldOn.open();
			jQuery(this).ajaxSubmit({
				dataType: 'json',
				success: function(resp) {
					HoldOn.close();
					if (resp.code == 'SUCCESS') {
						$('#tbclimsg').append('<tr><td class="text-center">A l\'instant</td><td class="text-center"><i class="gi gi-alarm"></i> ' + resp.comment + '</td><td class="text-center"><div class="btn-group"><a href="#" data-toggle="tooltip" title="Supprimer le rappel" class="btn btn-xs btn-danger btdelcomment" data-id="' + resp.id_comment + '"><i class="fa fa-trash"></i></a></div></td></tr>');
						$('#nbcomment').text((parseInt($('#nbcomment').text()) || 0) + 1);
						$("body").tooltip({
							selector: '[data-toggle="tooltip"]'
						});
						$('#modal-recall').modal('hide');
					} else
					if (resp.code == 'ERROR')
						$.bootstrapGrowl('<h4>Erreur!</h4> <p>' + resp.message + '</p>', {
							type: 'danger',
							delay: 2500,
							allow_dismiss: true
						});

				},
				error: function() {
					HoldOn.close();
				}
			});
			return false;
		});

		Dropzone.options.myAwesomeDropzone = {
			init: function() {
				this.on("success", function(file, txt) {
					var resp = JSON.parse(txt);
					if (resp.code == 'SUCCESS') {
						this.removeFile(file);
						$('#nbdoc').text((parseInt($('#nbdoc').text()) || 0) + 1);
						var str = '';
						if (resp.isimage == '1') {
							str += '<div class="col-sm-3 gallery-image"><img src="' + resp.filename + '" alt="image"><div class="gallery-image-options text-center"><div class="btn-group btn-group-sm">';
							str += '<a href="' + resp.filename + '" class="gallery-link btn btn-sm btn-alt btn-default" title="Ajoutée à l\'instant">Zoom</a>';
							str += '<a href="javascript:void(0)" class="btn btn-sm btn-alt btn-default deldoc" title="Supprimer" data-id="' + resp.id_doc + '"><i class="fa fa-trash"></i></a>';
							str += '</div></div></div>';
						} else {
							str += '<div class="col-sm-3 gallery-image gallery-file"><i class="hi hi-file"></i><br>' + resp.fl + '<div class="gallery-image-options text-center"><div class="btn-group btn-group-sm">';
							str += '<a href="' + resp.filename + '" target="new" class="btn btn-sm btn-alt btn-default" title="Ajoutée à l\'instant">Voir</a>';
							str += '<a href="javascript:void(0)" class="btn btn-sm btn-alt btn-default deldoc" title="Supprimer" data-id="' + resp.id_doc + '"><i class="fa fa-trash"></i></a>';
							str += '</div></div></div>';
						}
						$('#contentdocs .gallery .row').append(str);
					}
				});
			}
		};

		$(document).on('click', '.deldoc', function() {
			if (confirm('Supprimer le document ?')) {
				var obj = $(this);
				HoldOn.open();
				$.post('crmajax.php', {
					action: 'delete-doc',
					iddoc: obj.attr('data-id')
				}, function(resp) {
					HoldOn.close();
					if (resp.code == 'SUCCESS') {
						obj.parents('.gallery-image').remove();
						$('#nbdoc').text(parseInt($('#nbdoc').text()) - 1);
					} else
						$.bootstrapGrowl('<h4>Erreur!</h4> <p>' + resp.message + '</p>', {
							type: 'danger',
							delay: 2500,
							allow_dismiss: true
						});
				}, 'json');
			}
			return false;
		});


		var curtyprdv = 0;
		function loadRDVDispo(fdtfrom, fduration, fcrndeb, fcrnend, showdt, ftyperdv) {
			if (parseInt(fcrndeb) > parseInt(fcrnend)) {
				$.bootstrapGrowl('<h4>Erreur!</h4> <p>Le créneau de début est supérieur au créneau de fin !</p>', {
						type: 'danger',
						delay: 2500,
						allow_dismiss: true
					});
				return false;
			}
			curtyprdv = ftyperdv;
			HoldOn.open();
			$.post('crmajax.php', {
				action: 'get-rdv-planning',
				id_contact: $('#id_contact').val(),
				dtfrom: fdtfrom,
				duration: fduration,
				hr: '7', //$('#hr_rdv').val()
				crndeb : fcrndeb,
				crnend : fcrnend,
				typerdv:ftyperdv
			}, function(resp) {
				if (resp.code == 'SUCCESS') {
					$('#calrdv').fullCalendar('destroy');
					$('#calrdv').fullCalendar({
						schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
						header: {
							left: 'prev,next', //today',
							center: 'title',
							right: ''
						},
						locale: 'fr',
						dayNames: ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'],
						eventStartEditable: false,
						eventDurationEditable: false,
						eventResourceEditable: false,
						defaultView: 'timelineWeekRdv',
						allDaySlot: false,
						eventLimit: true,
						height: 620,
						slotWidth:80,
						displayEventTime: true,
						defaultDate: showdt,
						minTime: '07:00:00',
						maxTime: '21:00:00',
						resourceLabelText: 'Entrepots / Planning',
						resourceAreaWidth: '20%',
						slotDuration: {
							hours: 2
						},
						snapDuration: {
							minutes: 1
						},
						slotLabelFormat: ['dddd DD MMM YYYY', 'HH:mm'],
						views: {
							timelineWeekRdv: {
								type: 'timelineWeek',
								duration: {
									days: 1
								}
							}
						},
						eventDrop: function(event, delta, revertFunc, jsEvent, ui, view) {
							//
						},
						eventRender: function(event, element) {
							element.find('div.fc-title').html(element.find('div.fc-title').text());
							element.find('span.fc-title').html(element.find('span.fc-title').text());
							element.find('.fc-list-item-title').html(element.find('.fc-list-item-title').text());
							if (event.id == 0) {
								element.css('background-color', '#fffccc');
								element.css('color', '#000');
								element.css('cursor', 'pointer');
							}
							if (event.typerdv == '1') {
								element.css('border', 'solid 2px #0000ff');
							}

							$("body").tooltip({
								selector: '[data-toggle="tooltip"]'
							});
						},
						/*eventClick: function(calEvent, jsEvent, view) {
							console.log(calEvent);
							var link = 'tour.php?id_contact=' + calEvent.id_contact + '&id_entrepot=' + calEvent.id_entrepot + '&num_planning=' + calEvent.num_planning + '&date_rdv=' + calEvent.date_rdv + '&heure_start=' + calEvent.start.format('HH:mm') + '&heure_end=' + calEvent.end.format('HH:mm')+'&duration='+calEvent.duration;
							//console.log(link);
							if (calEvent.id == 0)
								location.href = link;
						},*/
						resourceRender: function(resourceObj, labelTds, bodyTds) {
							labelTds.find('.fc-cell-content').html(resourceObj.title);
						},
						eventAfterAllRender:function(view) {
							//setTimeout(function() {
								$('.fc-time-area.fc-widget-content .fc-scroller').animate({ scrollTop: 0 }, "fast");
								$('.fc-resource-area.fc-widget-content .fc-scroller').animate({ scrollTop: 0 }, "fast");
								HoldOn.close();
							//}, 500);
							//alert('ok');
						},
						resources: resp.plans,
						events: resp.rdvs
					});

					$("#calrdv").fullCalendar('render');
					$('#modal-rdv').modal();										
				} else {
					HoldOn.close();
					$.bootstrapGrowl('<h4>Erreur!</h4> <p>' + resp.message + '</p>', {
						type: 'danger',
						delay: 2500,
						allow_dismiss: true
					});
				}
			}, 'json');
		}

		$('#btgetrdv').click(function() {
			loadRDVDispo($('#date_from_rdv').val(), $('#duration_rdv').val(), $('#rdvcreneau_start').val(), $('#rdvcreneau_end').val(), $('#date_from_rdv').data('datepicker').getFormattedDate('yyyy-mm-dd'), '0');
			return false;
		});

		$('#btgetsav').click(function() {
			loadRDVDispo($('#date_from_sav').val(), $('#duration_sav').val(), $('#savcreneau_start').val(), $('#savcreneau_end').val(), $('#date_from_sav').data('datepicker').getFormattedDate('yyyy-mm-dd'), '1');
			return false;
		});

		$(document).on('click', '.fc-prev-button, .fc-next-button', function(){
			//$('#modal-rdv').modal('hide');
			var b = $('#calrdv').fullCalendar('getDate');
			if (curtyprdv == '0') {
				$('#date_from_rdv').data('datepicker').update(b.format('L'));
				$('#btgetrdv').click();
			}
			else {
				$('#date_from_sav').data('datepicker').update(b.format('L'));
				$('#btgetsav').click();
			}		    
		});

		$('#modal-rdv').on('shown.bs.modal', function() {
			$("#calrdv").fullCalendar('render');
		});

		$('.btconfrdv').click(function() {
			var cursts = $(this).attr('data-status');
			var str = cursts == '0' ? 'Confirmer' : 'Valider';
			if (confirm(str + ' le RDV ?')) {
				var obj = $(this);
				HoldOn.open();
				$.post('crmajax.php', {
					action: 'confirm-rdv',
					idrdv: obj.attr('data-id'),
					status: cursts
				}, function(resp) {
					HoldOn.close();
					if (resp.code == 'SUCCESS') {
						$('.tooltip.in').remove();
						if (cursts == '0') {
							obj.attr('title', 'Valider le RDV');
							obj.attr('data-original-title', 'Valider le RDV');
							obj.attr('data-status', '1');
							obj.parents('td').prev().text('Confirmé (A valider)');
							$("body").tooltip({
								selector: '[data-toggle="tooltip"]'
							});
						} else
						if (cursts == '1') {
							obj.parents('td').prev().text('Validé');
							obj.remove();
						}
					} else
						$.bootstrapGrowl('<h4>Erreur!</h4> <p>' + resp.message + '</p>', {
							type: 'danger',
							delay: 2500,
							allow_dismiss: true
						});
				}, 'json');
			}
			return false;
		});

		$('.btdelrdv').click(function() {
			if (confirm('Supprimer le RDV ?')) {
				var obj = $(this);
				HoldOn.open();
				$.post('crmajax.php', {
					action: 'delete-rdv',
					idrdv: obj.attr('data-id')
				}, function(resp) {
					HoldOn.close();
					if (resp.code == 'SUCCESS') {
						window.location.reload();
					} else
						$.bootstrapGrowl('<h4>Erreur!</h4> <p>' + resp.message + '</p>', {
							type: 'danger',
							delay: 2500,
							allow_dismiss: true
						});
				}, 'json');
			}
			return false;
		});


		$('#frminfodir').submit(function() {

			if ($('#101_m2').val() == '' && $('#102_m2').val() == '' && $('#103_m2').val() == '') {
				$.bootstrapGrowl('<h4>Erreur!</h4> <p>Veuillez renseigner la surface - type 101, 102, 103</p>', {
					type: 'danger',
					delay: 2500,
					allow_dismiss: true
				});
				$('#101_m2').focus();
				return false;
			}

			/*if (parseFloat($('#revenu_fiscal').val()) == 0) {
				$.bootstrapGrowl('<h4>Erreur!</h4> <p>Veuillez renseigner le revenu fiscal</p>', {
					type: 'danger',
					delay: 2500,
					allow_dismiss: true
				});
				$('#revenu_fiscal').focus();
				return false;
			}*/

			if (parseFloat($('#nb_person').val()) == 0) {
				$.bootstrapGrowl('<h4>Erreur!</h4> <p>Veuillez renseigner le nombre de personne du foyer</p>', {
					type: 'danger',
					delay: 2500,
					allow_dismiss: true
				});
				$('#nb_person').focus();
				return false;
			}

			HoldOn.open();
			jQuery(this).ajaxSubmit({
				dataType: 'json',
				data: {
					htmlimp: $('#modal-impot .modal-body').html()
				},
				success: function(resp) {
					if (resp.code == 'SUCCESS') {
						if ($('#id_prestation').val() == '')
							location.href = 'contact.php?id_contact=' + $('#id_contact').val();
						else {
							$('#cumac').text(resp.precainfo.cumac101 + resp.precainfo.cumac102 + resp.precainfo.cumac103);
							$('#type_preca').text(resp.precainfo.preca == '2' ? 'Grande précarité' : (resp.precainfo.preca == '1' ? 'Précarité' : 'Classique'));
							$('#type_chaufstr').text($('#type_chauf').val());
							$('#zone').text(resp.precainfo.zone);
							if (resp.dorefresh == '1')
								location.href = 'contact.php?id_contact=' + $('#id_contact').val();
							else
								$.bootstrapGrowl('<h4>Confirmation!</h4> <p>Modification effectuée</p>', {
									type: 'success',
									delay: 2500,
									allow_dismiss: true
								});
						}
					} else
					if (resp.code == 'ERROR')
						$.bootstrapGrowl('<h4>Erreur!</h4> <p>' + resp.message + '</p>', {
							type: 'danger',
							delay: 2500,
							allow_dismiss: true
						});
					HoldOn.close();
				},
				error: function() {
					HoldOn.close();
				}
			});

			return false;
		});


		$('#frminfofisc').submit(function() {
			HoldOn.open();
			jQuery(this).ajaxSubmit({
				dataType: 'json',
				data: {
					htmlimp: $('#modal-impot .modal-body').html()
				},
				success: function(resp) {
					if (resp.code == 'SUCCESS') {
						$.bootstrapGrowl('<h4>Confirmation!</h4> <p>Modification effectuée</p>', {
							type: 'success',
							delay: 2500,
							allow_dismiss: true
						});
					} else
					if (resp.code == 'ERROR')
						$.bootstrapGrowl('<h4>Erreur!</h4> <p>' + resp.message + '</p>', {
							type: 'danger',
							delay: 2500,
							allow_dismiss: true
						});
					HoldOn.close();
				},
				error: function() {
					HoldOn.close();
				}
			});

			return false;
		});

		/*
		$('#btsyncfiscct').click(function() {
			if ($('#q_no_fiscal_1').val() == '' || $('#q_ref_avis_1').val() == '') {
				$.bootstrapGrowl('<h4>Erreur!</h4> <p>Veuillez renseigner le numero fiscal et reference de l\'avis d\'imposition</p>', {
					type: 'danger',
					delay: 2500,
					allow_dismiss: true
				});
				return false;
			}

			HoldOn.open();
			$.post('crmajax.php', {
				action: 'sync-fisc',
				nofisc1: $('#q_no_fiscal_1').val(),
				nofisc2: $('#q_no_fiscal_2').val(),
				nofisc3: $('#q_no_fiscal_3').val(),
				nofisc4: $('#q_no_fiscal_4').val(),
				nofisc5: $('#q_no_fiscal_5').val(),
				refavis1: $('#q_ref_avis_1').val(),
				refavis2: $('#q_ref_avis_2').val(),
				refavis3: $('#q_ref_avis_3').val(),
				refavis4: $('#q_ref_avis_4').val(),
				refavis5: $('#q_ref_avis_5').val()
			}, function(resp) {
				HoldOn.close();
				if (resp.code == 'SUCCESS') {
					$('#q_revenu_fiscal').val(resp.rev);
					$('#q_nb_person').val(resp.nbperson);
					$('#modal-impot .modal-body').html(resp.html.replace(/<img[^>]*>/g, ""));
					$('.btviewimpot').show();
				} else
					$.bootstrapGrowl('<h4>Erreur!</h4> <p>' + resp.message + '</p>', {
						type: 'danger',
						delay: 2500,
						allow_dismiss: true
					});
			}, 'json');

			return false;
		});
		*/

		$('#btsyncfisc').click(function() {
			if ($('#no_fiscal_1').val() == '' || $('#ref_avis_1').val() == '') {
				$.bootstrapGrowl('<h4>Erreur!</h4> <p>Veuillez renseigner le numero fiscal et reference de l\'avis d\'imposition</p>', {
					type: 'danger',
					delay: 2500,
					allow_dismiss: true
				});
				return false;
			}

			HoldOn.open();
			$.post('crmajax.php', {
				action: 'sync-fisc',
				nofisc1: $('#no_fiscal_1').val(),
				nofisc2: $('#no_fiscal_2').val(),
				nofisc3: $('#no_fiscal_3').val(),
				nofisc4: $('#no_fiscal_4').val(),
				nofisc5: $('#no_fiscal_5').val(),
				refavis1: $('#ref_avis_1').val(),
				refavis2: $('#ref_avis_2').val(),
				refavis3: $('#ref_avis_3').val(),
				refavis4: $('#ref_avis_4').val(),
				refavis5: $('#ref_avis_5').val()
			}, function(resp) {
				HoldOn.close();
				if (resp.code == 'SUCCESS') {
					//$('body').append(resp.html);
					$('#revenu_fiscal').val(resp.rev);
					$('#nb_person').val(resp.nbperson);
					$('#nb_foyer').val(resp.nbfoyer);
					/*if ($('#id_contact').val() == '0') {
						$('#first_name').val(resp.fname);
						$('#last_name').val(resp.lname);
						$('#adr1').val(resp.adr);
						$('#post_code').val(resp.cp);
						$('#city').val(resp.vil);
						$('#dept').val(resp.cp.substr(0, 2));
					} else {
						if ($('#first_name').val() == '')
							$('#first_name').val(resp.fname);
						if ($('#last_name').val() == '')
							$('#last_name').val(resp.lname);
						if ($('#adr1').val() == '')
							$('#adr1').val(resp.adr);
						if ($('#cp').val() == '') {
							$('#cp').val(resp.cp);
							$('#dept').val(resp.cp.substr(0, 2));
						}
						if ($('#city').val() == '')
							$('#adr1').val(resp.cil);
					}*/

					$('#modal-impot .modal-body').html(resp.html.replace(/<img[^>]*>/g, ""));
					$('.btviewimpot').show();
				} else
					$.bootstrapGrowl('<h4>Erreur!</h4> <p>' + resp.message + '</p>', {
						type: 'danger',
						delay: 2500,
						allow_dismiss: true
					});
			}, 'json');

			return false;
		});

		$('.btviewimpot').click(function() {
			$('#modal-impot').modal();
			return false;
		});



		
		//var options = {types: ['geocode']};
		var inp = document.getElementById('adr1');
		var autoComplete = new google.maps.places.Autocomplete(inp); //, options);
		google.maps.event.addListener(autoComplete, 'place_changed', function() {
			var place = autoComplete.getPlace();

			if (!place.geometry) {
				return;
			}

			var numst = '';
			var adr = '';
			var cp = '';
			var ville = '';
			var pays = '';
			console.log(place.address_components);
			for (var d in place.address_components) {
				for (var d2 in place.address_components[d].types)
					if (place.address_components[d].types[d2] == 'locality')
						ville = place.address_components[d].short_name;
					else
				if (place.address_components[d].types[d2] == 'country')
					pays = place.address_components[d].long_name;
				else
				if (place.address_components[d].types[d2] == 'postal_code')
					cp = place.address_components[d].long_name;
				else
				if (place.address_components[d].types[d2] == 'route')
					adr = place.address_components[d].long_name;
				else
				if (place.address_components[d].types[d2] == 'street_number')
					numst = place.address_components[d].long_name;
			}


			$('#city').val(ville);
			$('#post_code').val(cp);
			$('#adr1').val(numst + ' ' + adr);
			$('#geolat').val(place.geometry.location.lat());
			$('#geolng').val(place.geometry.location.lng());
			console.log(place);
		});

		<?php if ($curusr) { ?>

			var latlngbounds = new google.maps.LatLngBounds();
			var myLatlng = new google.maps.LatLng($('#geolat').val(), $('#geolng').val());
			var mapOptions = {
				zoom: 15,
				center: myLatlng,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			};
			var map = new google.maps.Map(document.getElementById("map"), mapOptions);

			var marker = new google.maps.Marker({
				position: myLatlng,
				center: myLatlng,
				map: map,
				icon: {
					path: fontawesome.markers.CHILD,
					scale: 0.5,
					strokeWeight: 0.5,
					strokeColor: 'black',
					strokeOpacity: 1,
					fillColor: '#1bbae1',
					fillOpacity: 1
				},
				title: 'Adresse de ' + $('#first_name').val() + ' ' + $('#last_name').val()
			});
			marker.setMap(map);
			latlngbounds.extend(myLatlng);

			<?php if ($curusr && ($curusr->entlat != 0 || $curusr->entlng != 0)) { ?>
				var myLatlngent = new google.maps.LatLng(<?php echo $curusr->entlat.', '.$curusr->entlng; ?>);
				var markerent = new google.maps.Marker({
					position: myLatlngent,
					center: myLatlngent,
					map: map,
					icon: {
						path: fontawesome.markers.HOME,
						scale: 0.5,
						strokeWeight: 0.5,
						strokeColor: 'black',
						strokeOpacity: 1,
						fillColor: '#e74c3c',
						fillOpacity: 1
					},
					title: 'Entrepot <?php echo $curusr->entrepot_name; ?>'
				});
				markerent.setMap(map);	
				latlngbounds.extend(myLatlngent);			
			<?php } ?>

			$("a[href='#tabs-local']").on('shown.bs.tab', function() {
				$("#map").css("height", 410);
				google.maps.event.trigger(map, 'resize');
				map.setCenter(latlngbounds.getCenter());
				map.fitBounds(latlngbounds);
			});

			$("a[href='#tabs-cadastre']").on('shown.bs.tab', function() {
				setTimeout(function() {
					$('#frmcadastre').attr('src', $('#frmcadastre').attr('data-src'));
				}, 1000);
			});


			App.datatables();

			/* Initialize Datatables */
			$('#tbcliprox').dataTable({
				pageLength: 10,
				lengthMenu: [
					[10, 20, 30, -1],
					[10, 20, 30, 'All']
				]
			});

			/* Add placeholder attribute to the search input */
			$('.dataTables_filter input').attr('placeholder', 'Search');

			$('ul[data-toggle="tabs"] a').on('show.bs.tab', function(e) {
				localStorage.setItem('activeTab_<?php echo $_GET['id_contact']; ?>', $(e.target).attr('href'));
			});
			var activeTab = localStorage.getItem('activeTab_<?php echo $_GET['id_contact']; ?>');
			if (activeTab) {
				$('ul[data-toggle="tabs"] a[href="' + activeTab + '"]').tab('show');
			}
		<?php } ?>

	});
</script>

<?php include 'inc/template_end.php'; ?>